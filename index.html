<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDM Products - AI Chatbot Demo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: #0a0a1a;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
}

#site-bg {
  position: fixed; inset: 0;
  width: 100%; height: 100%;
  z-index: 0;
  object-fit: cover;
  object-position: top center;
}

/* â”€â”€ Chat Bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-bubble {
  position: fixed; bottom: 28px; right: 28px; z-index: 1000;
  width: 64px; height: 64px; border-radius: 50%;
  background: #111a6e;
  box-shadow: 0 4px 24px rgba(17,26,110,.5);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: transform .2s, box-shadow .2s;
  border: none; outline: none;
}
#chat-bubble:hover { transform: scale(1.08); box-shadow: 0 6px 32px rgba(17,26,110,.6); }
#chat-bubble svg { width: 30px; height: 30px; fill: #fff; }
#chat-bubble .close-icon { display: none; }
#chat-bubble.open .chat-icon { display: none; }
#chat-bubble.open .close-icon { display: block; }

.unread-badge {
  position: absolute; top: -2px; right: -2px;
  width: 20px; height: 20px; background: #e63946;
  border-radius: 50%; color: #fff; font-size: 11px;
  font-weight: 700; display: flex; align-items: center; justify-content: center;
  border: 2px solid #fff;
  animation: pulse-badge 2s infinite;
}
@keyframes pulse-badge {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}
.unread-badge.hidden { display: none; }

/* â”€â”€ Chat Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-window {
  position: fixed; bottom: 104px; right: 28px; z-index: 999;
  width: 24rem; height: 44rem; max-height: calc(100vh - 130px);
  background: #fff; border-radius: 16px;
  box-shadow: 0 12px 48px rgba(0,0,0,.2);
  display: flex; flex-direction: column;
  transform: scale(0) translateY(20px);
  transform-origin: bottom right;
  opacity: 0; pointer-events: none;
  transition: transform .3s cubic-bezier(.175,.885,.32,1.275), opacity .2s;
  overflow: hidden;
}
#chat-window.open {
  transform: scale(1) translateY(0);
  opacity: 1; pointer-events: auto;
}

/* â”€â”€ Chat Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-header {
  background: linear-gradient(135deg, #111a6e, #1a237e);
  color: #fff; padding: 18px 20px;
  display: flex; align-items: center; gap: 14px;
  flex-shrink: 0;
}
.agent-avatar {
  width: 44px; height: 44px; border-radius: 50%;
  background: rgba(255,255,255,.2); display: flex;
  align-items: center; justify-content: center;
  font-size: 20px; font-weight: 700; flex-shrink: 0;
  border: 2px solid rgba(255,255,255,.3);
}
.agent-info h3 { font-size: 15px; font-weight: 700; letter-spacing: .2px; }
.agent-info p { font-size: 11.5px; opacity: .85; margin-top: 2px; }
.online-dot {
  width: 8px; height: 8px; background: #4ade80;
  border-radius: 50%; display: inline-block; margin-right: 5px;
  box-shadow: 0 0 6px rgba(74,222,128,.6);
}

/* â”€â”€ Chat Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-messages {
  flex: 1; overflow-y: auto; padding: 20px;
  display: flex; flex-direction: column; gap: 10px;
  background: #f7f8fa;
  scroll-behavior: smooth;
}
.chat-messages::-webkit-scrollbar { width: 5px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

.msg {
  max-width: 85%; padding: 11px 15px;
  border-radius: 16px; font-size: 13.5px; line-height: 1.55;
  animation: msgIn .3s ease-out;
  word-wrap: break-word;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.msg.bot {
  align-self: flex-start;
  background: #fff; color: #333;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.msg.user {
  align-self: flex-end;
  background: #111a6e; color: #fff;
  border-bottom-right-radius: 4px;
}
.msg a { color: #111a6e; font-weight: 600; text-decoration: underline; }
.msg.user a { color: #c5caff; }

/* â”€â”€ Typing Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.typing-indicator {
  align-self: flex-start;
  display: flex; gap: 5px; padding: 14px 18px;
  background: #fff; border-radius: 16px;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.typing-indicator span {
  width: 7px; height: 7px; background: #bbb; border-radius: 50%;
  animation: blink 1.4s infinite both;
}
.typing-indicator span:nth-child(2) { animation-delay: .2s; }
.typing-indicator span:nth-child(3) { animation-delay: .4s; }
@keyframes blink {
  0%,80%,100% { opacity: .3; transform: scale(.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* â”€â”€ Chat Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-input-area {
  padding: 12px 14px; background: #fff;
  border-top: 1px solid #eee; display: flex; gap: 8px;
  align-items: center; flex-shrink: 0;
}
.chat-input-area input {
  flex: 1; padding: 11px 15px; border: 1.5px solid #ddd;
  border-radius: 24px; font-size: 13.5px; outline: none;
  transition: border-color .2s;
  font-family: inherit;
}
.chat-input-area input:focus { border-color: #111a6e; }
.chat-input-area button {
  width: 40px; height: 40px; border-radius: 50%;
  background: #111a6e; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background .15s;
  flex-shrink: 0;
}
.chat-input-area button:hover { background: #1a237e; }
.chat-input-area button svg { width: 17px; height: 17px; fill: #fff; }

.powered-by {
  text-align: center; padding: 6px; background: #fafafa;
  font-size: 10px; color: #aaa; border-top: 1px solid #f0f0f0;
  flex-shrink: 0;
}

/* â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  #chat-window {
    width: calc(100vw - 16px); right: 8px; bottom: 96px;
    max-height: calc(100vh - 120px);
    height: calc(100vh - 120px);
    border-radius: 12px;
  }
}
</style>
</head>
<body>

<img id="site-bg" src="screenshot.png" alt="JDM Products Website" />

<button id="chat-bubble" onclick="toggleChat()" aria-label="Open chat">
  <svg class="chat-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/><path d="M7 9h10v2H7zm0-3h10v2H7zm0 6h7v2H7z"/></svg>
  <svg class="close-icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
  <div class="unread-badge" id="unread-badge">1</div>
</button>

<div id="chat-window">
  <div class="chat-header">
    <div class="agent-avatar">M</div>
    <div class="agent-info">
      <h3>Michael</h3>
      <p><span class="online-dot"></span>Online</p>
    </div>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-area">
    <input type="text" id="chat-input" placeholder="Type your message..." autocomplete="off" />
    <button onclick="sendMessage()" aria-label="Send"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </div>
  <div class="powered-by">Powered by braind AI &middot; Demo</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JDM INTELLIGENT CHATBOT â€” FULL KNOWLEDGE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Conversation State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CTX = {
  userLocation: null,
  businessType: null,
  customerStatus: null,
  mentionedBrands: [],
  topicsDiscussed: [],
  contactName: null,
  businessName: null,
  email: null,
  phone: null,
  sentiment: 'neutral'
};

const STATE = {
  open: false,
  greeted: false,
  flow: null,
  flowStep: 0,
  leadData: {},
  lastActivity: Date.now(),
  timeoutFired: false
};

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $msgs = document.getElementById('chat-messages');
const $input = document.getElementById('chat-input');
const $window = document.getElementById('chat-window');
const $bubble = document.getElementById('chat-bubble');
const $badge = document.getElementById('unread-badge');

// â”€â”€ Brand Knowledge Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BRAND_DB = {
  garmin: {
    name: 'Garmin',
    since: 2015,
    official: true,
    categories: ['fitness','outdoor','marine','automotive','golf'],
    desc: "Garmin is one of our flagship brands â€” we've been their official distributor for Ireland and UK since 2015. We carry their full range:\n\nâ€¢ Fitness & wellness (watches, activity trackers)\nâ€¢ Outdoor (hiking, camping GPS devices)\nâ€¢ Marine (boat navigation)\nâ€¢ Automotive (sat navs)\nâ€¢ Golf (rangefinders, GPS)",
    fitFor: { sports: 'fitness range', electronics: 'full tech range', outdoor: 'outdoor and hiking GPS range', online: 'full catalogue' }
  },
  fitbit: {
    name: 'Fitbit',
    since: null,
    official: true,
    categories: ['wellness','fitness tracking'],
    desc: "Fitbit is a strong wellness brand in our portfolio. Their smartwatches and fitness trackers appeal to health-conscious consumers.",
    fitFor: { sports: 'Fitbit is a natural fit alongside Garmin for your fitness customers', electronics: 'wellness wearables are a growing category', online: 'strong online demand for fitness wearables' }
  },
  tonies: {
    name: 'Tonies',
    since: null,
    official: true,
    categories: ['children','audio','entertainment'],
    desc: "Tonies is a unique children's audio entertainment system â€” very popular with parents of young kids. The Toniebox and character figures are consistently strong sellers.",
    fitFor: { children: "This would be perfect for your customer base", toy: "Tonies is one of the hottest products in the toy space right now", family: "Families love Tonies â€” it's a great fit" }
  },
  echelon: {
    name: 'Echelon',
    since: null,
    official: true,
    categories: ['fitness equipment','connected fitness'],
    desc: "Echelon offers connected fitness equipment â€” smart bikes, rowers, and more. They're growing rapidly in the home fitness market.",
    fitFor: { sports: "Works well alongside Garmin and Fitbit for a complete fitness offering", fitness: "A perfect complement to your fitness range" }
  },
  austere: {
    name: 'Austere',
    since: null,
    official: true,
    categories: ['premium cables','accessories'],
    desc: "Austere produces premium cables and accessories â€” high-quality, beautifully designed products that offer great margins for retailers."
  },
  'surefire gaming': {
    name: 'SureFire Gaming',
    since: null,
    official: true,
    categories: ['gaming','accessories'],
    desc: "SureFire Gaming offers a range of gaming accessories including headsets, keyboards, mice, and more. Great for retailers serving the gaming community."
  },
  aeno: {
    name: 'AENO',
    since: null,
    official: true,
    categories: ['smart home','appliances'],
    desc: "AENO provides smart home appliances â€” a growing category that appeals to tech-savvy consumers looking to upgrade their homes.",
    fitFor: { home: "AENO smart home products would be a great fit for your lifestyle customers", electronics: "Smart home is a fast-growing category" }
  },
  blackstone: {
    name: 'Blackstone Products',
    since: null,
    official: true,
    categories: ['BBQ','griddles','outdoor cooking'],
    desc: "Blackstone Products specialises in BBQ griddles and outdoor cooking equipment. We have exclusive UK distribution for their range."
  }
};

const BRAND_ALIASES = {
  'garman':'garmin','garmen':'garmin','garmon':'garmin','gamin':'garmin',
  'fitbt':'fitbit','fitbitt':'fitbit','fit bit':'fitbit','fitbat':'fitbit',
  'tonie':'tonies','tony':'tonies','tonnies':'tonies','tonys':'tonies','toniebox':'tonies',
  'echelan':'echelon','echellon':'echelon','eschelon':'echelon',
  'austeer':'austere','austre':'austere','austire':'austere',
  'surefire':'surefire gaming','sure fire':'surefire gaming','surefir':'surefire gaming',
  'aneo':'aeno','aino':'aeno','anio':'aeno',
  'blackston':'blackstone','black stone':'blackstone'
};

// â”€â”€ Location detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LOCATIONS_IE = ['dublin','cork','galway','limerick','waterford','kilkenny','bray','wicklow','drogheda','dundalk','sligo','athlone','wexford','carlow','kildare','meath','louth','mayo','donegal','kerry','clare','tipperary','offaly','laois','longford','westmeath','roscommon','leitrim','cavan','monaghan','ireland','irish'];
const LOCATIONS_UK = ['london','manchester','birmingham','leeds','glasgow','edinburgh','liverpool','bristol','sheffield','newcastle','nottingham','leicester','cardiff','belfast','derry','southampton','reading','brighton','cambridge','oxford','york','bath','exeter','norwich','coventry','stoke','wolverhampton','sunderland','derby','swansea','aberdeen','dundee','inverness','england','scotland','wales','northern ireland','uk','united kingdom','britain','british'];
const LOCATIONS_EU = ['france','germany','spain','italy','netherlands','belgium','portugal','austria','sweden','denmark','norway','finland','poland','czech','hungary','romania','greece','europe','european','eu'];

// â”€â”€ Business type detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BIZ_TYPES = {
  sports: ['sport','sports','fitness','gym','athletic','outdoor','running','cycling'],
  electronics: ['electronics','tech','technology','gadget','computer','phone','it store'],
  online: ['online','ecommerce','e-commerce','web','website','amazon','ebay','shopify'],
  department: ['department store','chain','retail chain','supermarket','argos','currys','harvey norman'],
  children: ['children','toy','toys','kids','baby','family','nursery'],
  home: ['home','lifestyle','homeware','interior','furniture','kitchen'],
  gaming: ['gaming','game','games','esports','pc gaming']
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function scrollBottom() {
  setTimeout(() => { $msgs.scrollTop = $msgs.scrollHeight; }, 60);
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function addMsg(html, sender) {
  const d = document.createElement('div');
  d.className = 'msg ' + sender;
  d.innerHTML = html;
  $msgs.appendChild(d);
  scrollBottom();
}

function showTyping() {
  hideTyping();
  const d = document.createElement('div');
  d.className = 'typing-indicator';
  d.id = 'typing';
  d.innerHTML = '<span></span><span></span><span></span>';
  $msgs.appendChild(d);
  scrollBottom();
}

function hideTyping() {
  const t = document.getElementById('typing');
  if (t) t.remove();
}

function botSay(text, _unused, delay) {
  const d = delay || Math.min(800 + text.length * 4, 2000);
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMsg(text, 'bot');
  }, d);
}

function match(text, keywords) {
  return keywords.some(k => text.includes(k));
}

function matchWord(text, words) {
  return words.some(w => {
    const re = new RegExp('\\b' + w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\b', 'i');
    return re.test(text);
  });
}

function detectBrand(text) {
  const lower = text.toLowerCase();
  for (const [alias, real] of Object.entries(BRAND_ALIASES)) {
    if (lower.includes(alias)) return real;
  }
  for (const b of Object.keys(BRAND_DB)) {
    if (lower.includes(b)) return b;
  }
  return null;
}

function detectLocation(text) {
  const lower = text.toLowerCase();
  for (const loc of LOCATIONS_IE) {
    if (lower.includes(loc)) return { place: loc, region: 'Ireland' };
  }
  for (const loc of LOCATIONS_UK) {
    if (lower.includes(loc)) return { place: loc, region: 'UK' };
  }
  for (const loc of LOCATIONS_EU) {
    if (lower.includes(loc)) return { place: loc, region: 'EU' };
  }
  return null;
}

function detectBusinessType(text) {
  const lower = text.toLowerCase();
  for (const [type, keywords] of Object.entries(BIZ_TYPES)) {
    if (keywords.some(k => lower.includes(k))) return type;
  }
  return null;
}

function detectSentiment(text) {
  const lower = text.toLowerCase();
  if (match(lower, ['urgent','asap','emergency','immediately','rush','quickly','now','critical'])) return 'urgent';
  if (match(lower, ['frustrated','annoyed','angry','terrible','awful','disappointed','unacceptable','ridiculous','problem','issue','not working','broken','useless'])) return 'frustrated';
  if (match(lower, ['great','excellent','wonderful','fantastic','amazing','love','brilliant','perfect'])) return 'positive';
  return 'neutral';
}

function extractEntities(text) {
  const loc = detectLocation(text);
  if (loc && !CTX.userLocation) {
    CTX.userLocation = loc;
  }
  const biz = detectBusinessType(text);
  if (biz && !CTX.businessType) {
    CTX.businessType = biz;
  }
  const brand = detectBrand(text);
  if (brand && !CTX.mentionedBrands.includes(brand)) {
    CTX.mentionedBrands.push(brand);
  }
  CTX.sentiment = detectSentiment(text);
}

function contextualNote() {
  let note = '';
  if (CTX.businessType && CTX.userLocation) {
    const bt = CTX.businessType.charAt(0).toUpperCase() + CTX.businessType.slice(1);
    const loc = CTX.userLocation.place.charAt(0).toUpperCase() + CTX.userLocation.place.slice(1);
    note = `For ${bt.toLowerCase()} retailers in ${loc}, `;
  } else if (CTX.businessType) {
    const bt = CTX.businessType.charAt(0).toUpperCase() + CTX.businessType.slice(1);
    note = `For ${bt.toLowerCase()} businesses, `;
  } else if (CTX.userLocation) {
    const loc = CTX.userLocation.place.charAt(0).toUpperCase() + CTX.userLocation.place.slice(1);
    note = `For retailers in ${loc}, `;
  }
  return note;
}

function deliveryNote() {
  if (CTX.userLocation) {
    const r = CTX.userLocation.region;
    if (r === 'Ireland') return "For deliveries in Ireland, we typically achieve next-day or 2-day delivery from our Bray facility.";
    if (r === 'UK') return "For UK deliveries, we typically achieve 1-2 day delivery from our Daventry facility.";
    if (r === 'EU') return "For EU deliveries, we typically deliver within 3-7 business days.";
  }
  return '';
}

function brandFit(brandKey) {
  const brand = BRAND_DB[brandKey];
  if (!brand || !brand.fitFor || !CTX.businessType) return '';
  const fit = brand.fitFor[CTX.businessType];
  return fit ? `\n\n${fit}.` : '';
}

function trackTopic(topic) {
  if (!CTX.topicsDiscussed.includes(topic)) {
    CTX.topicsDiscussed.push(topic);
  }
}

function urgentPrefix() {
  if (CTX.sentiment === 'urgent') {
    return "I understand this is time-sensitive. ";
  }
  if (CTX.sentiment === 'frustrated') {
    return "I'm sorry you're experiencing issues â€” let me make sure we get this sorted. ";
  }
  return '';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT TOGGLE & GREETING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleChat() {
  STATE.open = !STATE.open;
  $window.classList.toggle('open', STATE.open);
  $bubble.classList.toggle('open', STATE.open);
  $badge.classList.add('hidden');
  if (STATE.open) {
    $input.focus();
    if (!STATE.greeted) {
      STATE.greeted = true;
      greet();
    }
  }
}

function greet() {
  botSay(
    "Hi there, I'm <strong>Michael</strong> from <strong>JDM Products</strong>. I help retailers with product inquiries, stock availability, and partnership opportunities.<br><br>Whether you're an existing customer, interested in becoming a retail partner, or just exploring â€” I'm here to help. What can I do for you?",
    null,
    800
  );
}

// â”€â”€ Inactivity timeout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  if (STATE.open && !STATE.timeoutFired && Date.now() - STATE.lastActivity > 300000) {
    STATE.timeoutFired = true;
    botSay("Still here if you need anything! Feel free to ask a question or I can connect you with our team.");
  }
}, 30000);


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function sendMessage() {
  const text = $input.value.trim();
  if (!text) return;
  $input.value = '';
  handleUserInput(text);
}
$input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

function handleUserInput(raw) {
  addMsg(escHtml(raw), 'user');
  STATE.lastActivity = Date.now();
  STATE.timeoutFired = false;
  const text = raw.toLowerCase().trim();

  // Extract entities from every message
  extractEntities(text);

  // If in a multi-step flow, continue it
  if (STATE.flow) {
    continueFlow(raw, text);
    return;
  }

  // â”€â”€ Intent Detection (priority order) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // 1. Customer status responses
  if (match(text, ['existing customer','current customer','already a customer','i have an account','have account','my account'])) {
    CTX.customerStatus = 'existing';
    handleExistingCustomerWelcome();
    return;
  }
  if (match(text, ['new retailer','become a retailer','new partner','become a partner','partner with','partnership','open an account','open account','sign up','sign me up','want to sell','want to stock','start selling','stock your products','become a stockist','apply','set up an account','new account','onboard','reseller','how to partner','retail partner','stockist'])) {
    CTX.customerStatus = 'prospect';
    startRetailerFlow();
    return;
  }
  if (match(text, ['just browsing','just looking','browsing','looking around','curious','explore'])) {
    CTX.customerStatus = 'browsing';
    handleBrowsing();
    return;
  }

  // 2. Check for specific brand mention
  const brand = detectBrand(text);
  if (brand) {
    handleSpecificBrand(brand);
    return;
  }

  // 3. Stock / availability
  if (match(text, ['stock','in stock','available','availability','inventory','lead time','out of stock'])) {
    trackTopic('stock');
    handleStock(text);
    return;
  }

  // 4. Pricing
  if (match(text, ['price','pricing','cost','how much','expensive','cheap','rates','margin','margins','wholesale price','price list'])) {
    trackTopic('pricing');
    handlePricing();
    return;
  }

  // 5. Delivery / logistics
  if (match(text, ['delivery','shipping','freight','logistics','deliver','transport','drop ship','dropship','drop shipping','courier','dispatch'])) {
    trackTopic('delivery');
    handleDelivery();
    return;
  }

  // 6. Payment terms
  if (match(text, ['payment terms','net 30','net 60','credit','pay later','invoice','credit terms','payment'])) {
    trackTopic('terms');
    handlePaymentTerms();
    return;
  }

  // 7. Returns & warranty
  if (match(text, ['return','returns','return policy','warranty','faulty','defective','damaged','broken','rma','after-sales','after sales'])) {
    trackTopic('returns');
    handleReturns();
    return;
  }

  // 8. Marketing support
  if (match(text, ['marketing','advertising','social media','pos materials','pos display','point of sale','in-store display','promotional','co-op','co-marketing','brand awareness'])) {
    trackTopic('marketing');
    handleMarketing();
    return;
  }

  // 9. Portal access
  if (match(text, ['portal','login','log in','b2b','online ordering','account access','can\'t log in','cant log in','password','reset password'])) {
    handlePortal();
    return;
  }

  // 10. Minimum order
  if (match(text, ['minimum order','minimum spend','mov','how much minimum','min order'])) {
    trackTopic('minimums');
    handleMinimumOrder();
    return;
  }

  // 11. Brands / product general inquiry
  if (match(text, ['brand','brands','product','products','range','catalogue','catalog','what do you sell','what do you distribute','what do you carry','portfolio'])) {
    handleBrandOverview();
    return;
  }

  // 12. Services general
  if (match(text, ['services','what do you offer','how can you help','support','training','events','trade show'])) {
    handleServices();
    return;
  }

  // 13. Company info / about
  if (match(text, ['about jdm','who is jdm','who are jdm','tell me about jdm','tell me about your company','company','history','founded','who are you','what is jdm','what does jdm do','jonathan moore'])) {
    handleAbout();
    return;
  }

  // 14. Regional / territory
  if (match(text, ['region','country','countries','europe','european','expand','expansion','cover','territory','where do you','coverage','where are you'])) {
    handleRegional();
    return;
  }

  // 15. Contact
  if (match(text, ['contact','phone','call','email','reach','speak to someone','talk to someone','human','real person','agent','call you','your number','phone number'])) {
    handleContact();
    return;
  }

  // 16. Objections
  if (match(text, ['already have a distributor','have a distributor','existing distributor','current distributor','happy with our','already work with'])) {
    handleObjectionExistingDistributor();
    return;
  }
  if (match(text, ['too expensive','too high','prices are high','too costly','cheaper','better price','not competitive'])) {
    handleObjectionPrice();
    return;
  }
  if (match(text, ['buy direct','direct from manufacturer','go direct','manufacturer direct','cut out the middleman'])) {
    handleObjectionDirect();
    return;
  }
  if (match(text, ['match price','price match','competitor','beat the price','match their price'])) {
    handleObjectionPriceMatch();
    return;
  }
  if (match(text, ['think about it','need to think','consider it','not sure yet','maybe later','come back','need time'])) {
    handleObjectionThinkAboutIt();
    return;
  }

  // 17. Greetings
  if (matchWord(text, ['hi','hello','hey','howdy','hiya','yo','sup']) || match(text, ['good morning','good afternoon','good evening'])) {
    botSay("Hello! Great to hear from you. How can I help you today?", ['Our Brands', 'Become a Partner', 'Stock Availability']);
    return;
  }

  // 18. Thanks
  if (match(text, ['thanks','thank you','cheers','appreciate','thx','tysm']) || matchWord(text, ['ta'])) {
    botSay("You're welcome! Is there anything else I can help you with?", ['Yes, another question', 'No, that\'s all']);
    return;
  }

  // 19. Goodbye
  if (match(text, ['bye','goodbye','that\'s all','no thanks','all good','no that\'s it','see you','take care','nothing else','no more questions','that\'s everything','i\'m good','im good'])) {
    botSay("Thanks for chatting! If you need anything in the future, we're always here. Have a great day. ğŸ‘‹");
    return;
  }

  // 20. Yes / agreement (contextual)
  if (match(text, ['yes please','go ahead','absolutely','definitely']) || matchWord(text, ['yes','yeah','yep','sure','ok','okay','please'])) {
    handleAffirmative(text);
    return;
  }

  // 21. Urgent
  if (CTX.sentiment === 'urgent') {
    handleUrgent();
    return;
  }

  // 22. Frustrated
  if (CTX.sentiment === 'frustrated') {
    handleFrustrated(text);
    return;
  }

  // 23. Buying signals
  if (match(text, ['interested in','looking for','considering','exploring','want to know','tell me more','more info','information'])) {
    handleBuyingSignal(text);
    return;
  }

  // 24. Off-topic / fun
  if (match(text, ['weather','football','soccer','rugby','gaa','politics','joke','funny','what\'s the time','who are you','are you real','are you ai','are you a bot','chatgpt','gpt'])) {
    handleOffTopic();
    return;
  }

  // 25. Demo question
  if (match(text, ['demo','this a demo','is this real','demonstration','test','full version','production','real version','ai version'])) {
    handleDemoQuestion();
    return;
  }

  // 26. Fallback
  handleFallback(text);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOW HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function continueFlow(raw, text) {
  const f = STATE.flow;
  if (f === 'retailer') continueRetailerFlow(raw, text);
  else if (f === 'lead') continueLeadFlow(raw, text);
  else if (f === 'existingHelp') continueExistingFlow(raw, text);
  else { STATE.flow = null; handleUserInput(raw); }
}

// â”€â”€ Retailer Onboarding Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startRetailerFlow() {
  STATE.flow = 'retailer';
  STATE.flowStep = 0;
  STATE.leadData = {};
  botSay(
    "Great! JDM works with retail partners of all sizes â€” from independent shops to major chains.<br><br>To get started, what <strong>type of retail business</strong> do you operate? (e.g., sports shop, electronics store, online retailer, department store)",
    ['Sports / Fitness', 'Electronics', 'Online Retail', 'Department Store', 'Other']
  );
}

function continueRetailerFlow(raw, text) {
  extractEntities(text);
  const step = STATE.flowStep;

  if (step === 0) {
    STATE.leadData.businessType = raw;
    if (!CTX.businessType) CTX.businessType = detectBusinessType(text) || raw;
    STATE.flowStep = 1;
    botSay("Where are you <strong>located</strong>?", ['Ireland', 'UK', 'EU / Other']);

  } else if (step === 1) {
    STATE.leadData.location = raw;
    if (!CTX.userLocation) {
      const loc = detectLocation(text);
      CTX.userLocation = loc || { place: raw, region: raw };
    }
    STATE.flowStep = 2;
    botSay("Are you currently stocking any <strong>consumer electronics brands</strong>? And do you have a <strong>physical store</strong>, <strong>online presence</strong>, or <strong>both</strong>?");

  } else if (step === 2) {
    STATE.leadData.currentSetup = raw;
    STATE.flowStep = 3;
    botSay("Which of our brands interest you most?", ['Garmin', 'Fitbit', 'Tonies', 'Echelon', 'Multiple / All']);

  } else if (step === 3) {
    STATE.leadData.brandsOfInterest = raw;
    STATE.flowStep = 4;
    const ctx = contextualNote();
    botSay(
      `${ctx ? ctx + 'we see really strong demand. ' : ''}Perfect! Based on what you've told me, you'd be a great fit for JDM. Our sales team will contact you within <strong>1-2 business days</strong> to discuss:<br><br>â€¢ Which brands suit your customer base<br>â€¢ Pricing and payment terms<br>â€¢ Marketing support available<br>â€¢ Getting you set up on our portal<br><br>Can I get your <strong>contact details</strong>? Let's start with your <strong>name</strong>.`
    );

  } else if (step === 4) {
    STATE.leadData.contactName = raw;
    CTX.contactName = raw;
    STATE.flowStep = 5;
    botSay(`Thanks, ${escHtml(raw.split(' ')[0])}. What's your <strong>business name</strong>?`);

  } else if (step === 5) {
    STATE.leadData.businessName = raw;
    CTX.businessName = raw;
    STATE.flowStep = 6;
    botSay("And your <strong>email address</strong>?");

  } else if (step === 6) {
    STATE.leadData.email = raw;
    CTX.email = raw;
    STATE.flowStep = 7;
    botSay("And a <strong>phone number</strong> in case our team needs to reach you directly?");

  } else if (step === 7) {
    STATE.leadData.phone = raw;
    CTX.phone = raw;
    STATE.flow = null;
    const name = STATE.leadData.contactName.split(' ')[0];
    const region = CTX.userLocation ? CTX.userLocation.region : 'Ireland/UK';
    const brandNote = CTX.mentionedBrands.length
      ? `They'll have specific information about <strong>${CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ')}</strong> availability and pricing for you.`
      : '';

    botSay(
      `Perfect! Thank you, <strong>${escHtml(name)}</strong>.<br><br>ğŸ“‹ Here's what happens next:<br>1. Our <strong>${escHtml(region)}</strong> sales manager will review your inquiry<br>2. They'll contact you at <strong>${escHtml(STATE.leadData.email)}</strong> within <strong>1-2 business days</strong><br>3. They'll discuss brands, pricing, terms, and how to get started<br><br>${brandNote}<br><br>In the meantime, feel free to browse or call us:<br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711<br><br>Looking forward to working with you!`,
      ['Ask another question', 'That\'s all, thanks']
    );
    console.log('[LEAD CAPTURED]', JSON.stringify(STATE.leadData, null, 2));
  }
}

// â”€â”€ Lead Capture (short) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startLeadFlow(context) {
  STATE.flow = 'lead';
  STATE.flowStep = 0;
  STATE.leadData = { inquiry: context || '' };
  botSay("I'd love to connect you with the right person. Could you share your <strong>name</strong> and <strong>business name</strong>?");
}

function continueLeadFlow(raw, text) {
  const step = STATE.flowStep;
  if (step === 0) {
    STATE.leadData.nameAndBusiness = raw;
    STATE.flowStep = 1;
    botSay("And your <strong>email</strong> and <strong>phone number</strong> so our team can follow up?");
  } else if (step === 1) {
    STATE.leadData.contactInfo = raw;
    STATE.flow = null;
    botSay(
      "Thanks for that! I've flagged your inquiry and one of our <strong>sales managers</strong> will reach out within <strong>1-2 business days</strong>.<br><br>You can also call us directly:<br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711<br><br>Anything else I can help with?",
      ['Yes, another question', 'No, that\'s all']
    );
    console.log('[LEAD CAPTURED]', JSON.stringify(STATE.leadData, null, 2));
  }
}

// â”€â”€ Existing Customer Help Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function continueExistingFlow(raw, text) {
  STATE.flow = null;
  extractEntities(text);
  // Re-route back to main handler
  if (match(text, ['stock','order','availability'])) { handleStock(text); }
  else if (match(text, ['portal','login','log in','password'])) { handlePortal(); }
  else if (match(text, ['return','warranty','faulty','broken'])) { handleReturns(); }
  else if (match(text, ['price','pricing','invoice'])) { handlePricing(); }
  else {
    botSay(
      "No problem. For specific account queries, your <strong>dedicated account manager</strong> is the best person to help. You can also reach us at:<br><br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711<br><br>What's your <strong>account name</strong>? I'll have your account manager get in touch."
    );
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOPIC RESPONSE HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleExistingCustomerWelcome() {
  CTX.customerStatus = 'existing';
  STATE.flow = 'existingHelp';
  botSay(
    "Perfect! I can help you with:<br><br>â€¢ Stock availability and orders<br>â€¢ Portal access issues<br>â€¢ Account inquiries<br>â€¢ Technical support<br>â€¢ Returns and warranty<br><br>What do you need help with today?",
    ['Stock Availability', 'Portal Access', 'Returns / Warranty', 'Talk to Account Manager']
  );
}

function handleBrowsing() {
  CTX.customerStatus = 'browsing';
  botSay(
    "No problem! Feel free to ask me about:<br><br>â€¢ Our brands (Garmin, Fitbit, Tonies, and more)<br>â€¢ How to become a JDM retail partner<br>â€¢ Stock and delivery<br>â€¢ Our services and support<br><br>What would you like to know?",
    ['Our Brands', 'Become a Partner', 'Services & Support']
  );
}

function handleBrandOverview() {
  trackTopic('brands');
  botSay(
    "JDM distributes a strong portfolio of leading consumer electronics brands:<br><br>â€¢ <strong>Garmin</strong> â€” Fitness, outdoor, marine, automotive, golf<br>â€¢ <strong>Fitbit</strong> â€” Wellness & fitness tracking<br>â€¢ <strong>Tonies</strong> â€” Children's audio entertainment<br>â€¢ <strong>Echelon</strong> â€” Connected fitness equipment<br>â€¢ <strong>Austere</strong> â€” Premium cables & accessories<br>â€¢ <strong>SureFire Gaming</strong> â€” Gaming accessories<br>â€¢ <strong>AENO</strong> â€” Smart home appliances<br>â€¢ <strong>Blackstone</strong> â€” BBQ griddles (exclusive UK distribution)<br>â€¢ Plus more across consumer electronics<br><br>Interested in any specific brand? I can go into more detail.",
    ['Tell me about Garmin', 'Tell me about Tonies', 'Become a stockist']
  );
}

function handleSpecificBrand(brandKey) {
  trackTopic('brands');
  if (!CTX.mentionedBrands.includes(brandKey)) CTX.mentionedBrands.push(brandKey);

  const brand = BRAND_DB[brandKey];
  if (!brand) {
    botSay(`Let me check on that... We focus primarily on Garmin, Fitbit, Tonies, Echelon, and several other consumer electronics brands. I can have our team confirm if we carry that or suggest similar alternatives. What type of products were you hoping to find?`);
    return;
  }

  let response = `${brand.desc}`;
  const fit = brandFit(brandKey);
  if (fit) response += fit;

  if (CTX.customerStatus === 'existing') {
    response += `<br><br>For current stock levels and pricing, check the portal at <a href="https://b2b.jdmproducts.com" target="_blank">b2b.jdmproducts.com</a> or contact your account manager.`;
    botSay(response, ['Check another brand', 'Stock availability', 'Contact my account manager']);
  } else {
    response += `<br><br>Are you interested in becoming a ${brand.name} stockist, or checking availability?`;
    botSay(response, [`Stock ${brand.name}`, 'See all brands', 'Check availability']);
  }
}

function handleStock(text) {
  const prefix = urgentPrefix();

  if (CTX.customerStatus === 'existing') {
    let resp = `${prefix}For current stock levels, please log into your account at <a href="https://b2b.jdmproducts.com" target="_blank">b2b.jdmproducts.com</a> where you'll see real-time availability.<br><br>Alternatively, your account manager can provide this immediately.`;
    if (CTX.mentionedBrands.length) {
      resp += ` For <strong>${CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ')}</strong> specifically, we typically maintain strong stock levels.`;
    }
    botSay(resp, ['Portal access help', 'Contact account manager']);
  } else {
    let resp = `${prefix}We maintain significant stock across our Ireland and UK facilities â€” local stock means fast delivery, not weeks from overseas.`;
    if (CTX.mentionedBrands.length) {
      const brandNames = CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ');
      resp += `<br><br>For <strong>${brandNames}</strong>, I can have our sales team provide current stock levels and lead times.`;
    } else {
      resp += `<br><br>Which brand or product are you interested in? I can have our sales team provide current stock levels and lead times.`;
    }
    botSay(resp, ['Garmin', 'Fitbit', 'Tonies', 'Contact sales team']);
  }
}

function handlePricing() {
  const prefix = urgentPrefix();
  let resp = `${prefix}Pricing is tailored to each retail partner based on order volume, relationship, and account terms. We offer competitive wholesale pricing with volume discounts.`;

  if (CTX.businessType) {
    const relevantBrands = {
      sports: 'Garmin, Fitbit, and Echelon',
      electronics: 'our full tech range',
      children: 'Tonies',
      gaming: 'SureFire Gaming',
      home: 'AENO smart home products',
      online: 'our full catalogue with dropship options'
    };
    const brands = relevantBrands[CTX.businessType] || 'our brand portfolio';
    resp += `<br><br>For ${CTX.businessType} businesses, we typically see strong margins on ${brands}.`;
  }

  resp += `<br><br>Would you like me to have one of our account managers send you a tailored price list?`;

  if (CTX.customerStatus === 'existing') {
    botSay(resp, ['Yes, send price list', 'Contact my account manager']);
  } else {
    botSay(resp, ['Yes, contact me', 'Tell me more first']);
  }
}

function handleDelivery() {
  const prefix = urgentPrefix();
  let resp = `${prefix}JDM has logistics facilities in both <strong>Ireland</strong> (Bray, Co. Wicklow) and <strong>UK</strong> (Daventry).<br><br>Standard delivery times:<br>â€¢ Ireland: <strong>1-3 business days</strong><br>â€¢ UK: <strong>1-3 business days</strong><br>â€¢ EU: <strong>3-7 business days</strong><br><br>We manage the full freight and transport network, including customs for EU orders.`;

  const dn = deliveryNote();
  if (dn) resp += `<br><br>${dn}`;

  resp += `<br><br>Drop shipping is also available for qualified accounts. Minimum order requirements and delivery costs vary by account type.`;

  botSay(resp, ['Become a partner', 'Payment terms', 'Drop shipping info']);
}

function handlePaymentTerms() {
  const prefix = urgentPrefix();
  let resp = `${prefix}JDM offers flexible payment terms for established business accounts:<br><br>â€¢ <strong>Net 30 days</strong><br>â€¢ <strong>Net 60 days</strong> (for larger accounts)<br><br>New retail partners typically start with advance payment or shorter terms, then move to Net terms once a trading relationship is established.<br><br>Credit terms are based on:<br>â€¢ Business size and turnover<br>â€¢ Trading history<br>â€¢ Credit check results`;

  if (CTX.customerStatus === 'prospect' || !CTX.customerStatus) {
    resp += `<br><br>Once you're set up as a JDM partner, we can work out payment terms that suit your cash flow needs.`;
  }

  botSay(resp, ['Set up an account', 'Delivery info', 'Our brands']);
}

function handleReturns() {
  const prefix = urgentPrefix();
  let resp = `${prefix}JDM provides comprehensive support for returns and warranties:<br><br>â€¢ <strong>Manufacturer warranty handling</strong> â€” We process warranty claims on behalf of retailers, so you don't deal with manufacturers directly<br>â€¢ <strong>Faulty product returns</strong> â€” Clear processes for defective items<br>â€¢ <strong>Technical support</strong> â€” Our team can help diagnose issues before returns<br><br>Specific return policies depend on the reason:<br>â€¢ Manufacturing defects: Full support under warranty<br>â€¢ Commercial returns: Varies by circumstance<br>â€¢ Damaged in transit: Handled case-by-case`;

  if (CTX.customerStatus === 'existing') {
    resp += `<br><br>Your account manager can walk you through the exact process. What's your account name?`;
    botSay(resp, ['Contact account manager', 'Call directly']);
  } else {
    resp += `<br><br>Once you're a JDM partner, you'll have dedicated support for all returns and warranty issues.`;
    botSay(resp, ['Become a partner', 'Ask another question']);
  }
}

function handleMarketing() {
  const prefix = urgentPrefix();
  let resp = `${prefix}JDM actively invests in supporting our retail partners! We provide:<br><br>ğŸ“± <strong>Social Media Support:</strong><br>â€¢ Daily content updates featuring our brands<br>â€¢ Co-brandable content you can use<br>â€¢ Product announcements and promotions<br><br>ğŸª <strong>In-Store Support:</strong><br>â€¢ POS materials and displays<br>â€¢ Product demo units (for qualified accounts)<br>â€¢ Shelf talkers and signage<br><br>ğŸ“Š <strong>Marketing Programs:</strong><br>â€¢ Co-op marketing opportunities<br>â€¢ Brand awareness campaigns<br>â€¢ Seasonal promotional support<br><br>ğŸ“ <strong>Training & Events:</strong><br>â€¢ Product training sessions<br>â€¢ Trade show participation<br>â€¢ Consumer events and demos<br><br>This is included as part of being a JDM partner â€” we succeed when you succeed!`;

  if (CTX.businessType) {
    const support = {
      sports: 'product demo units and fitness-focused POS materials',
      electronics: 'tech spec sheets and digital marketing assets',
      online: 'product imagery, descriptions, and digital content packs',
      children: 'Tonies display units and seasonal promotional kits',
      gaming: 'gaming-focused POS and event support'
    };
    const s = support[CTX.businessType];
    if (s) resp += `<br><br>For ${CTX.businessType} businesses, we typically provide ${s}.`;
  }

  botSay(resp, ['Become a partner', 'Our brands', 'Pricing info']);
}

function handlePortal() {
  if (CTX.customerStatus === 'existing' || match('', [])) {
    botSay(
      `The JDM partner portal is at: <a href="https://b2b.jdmproducts.com" target="_blank"><strong>b2b.jdmproducts.com</strong></a><br><br>Through the portal you can:<br>â€¢ Check real-time stock availability<br>â€¢ Place orders 24/7<br>â€¢ View order history and tracking<br>â€¢ Make payments<br>â€¢ Download invoices<br><br>Having trouble logging in? Common fixes:<br>â€¢ Forgotten password â€” Use the 'Reset Password' link<br>â€¢ Account not set up â€” Contact your account manager<br>â€¢ Technical issues â€” Clear browser cache or try a different browser<br><br>If you're still stuck, call us:<br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711`,
      ['Reset password help', 'Contact account manager']
    );
  } else {
    botSay(
      `Once you're set up as a JDM retail partner, you'll get access to our B2B portal at <a href="https://b2b.jdmproducts.com" target="_blank"><strong>b2b.jdmproducts.com</strong></a> where you can check stock and place orders 24/7.<br><br>Interested in becoming a partner?`,
      ['Yes, sign me up', 'Tell me more']
    );
  }
}

function handleMinimumOrder() {
  let resp = `Minimum order requirements vary depending on:<br>â€¢ Account type and size<br>â€¢ Delivery location<br>â€¢ Payment terms<br><br>Typically:<br>â€¢ <strong>Smaller independent retailers:</strong> Lower minimums to help you get started<br>â€¢ <strong>Larger accounts:</strong> Standard MOVs apply but with better terms<br>â€¢ Free delivery thresholds vary by location`;

  if (CTX.businessType || CTX.userLocation) {
    const loc = CTX.userLocation ? CTX.userLocation.place : 'your area';
    const biz = CTX.businessType || 'your business type';
    resp += `<br><br>For ${biz} retailers in ${loc}, I can have our team provide specific minimums and delivery thresholds.`;
  }

  resp += `<br><br>This is something we work out during account setup based on your business needs.`;
  botSay(resp, ['Set up an account', 'Talk to sales']);
}

function handleServices() {
  botSay(
    "JDM offers a complete suite of distribution services:<br><br>ğŸ“¦ <strong>Logistics</strong> â€” Pan-European freight network with facilities in Ireland and the UK. 1-3 day delivery.<br><br>ğŸ‘¥ <strong>Sales Management</strong> â€” Regional sales teams covering UK and Ireland, managing 3,000+ accounts with dedicated account managers.<br><br>ğŸ“¢ <strong>Marketing</strong> â€” Social media, co-marketing, POS materials, brand awareness campaigns.<br><br>ğŸ“ <strong>Events & Training</strong> â€” Trade shows, B2B events, product training for retail staff.<br><br>ğŸ”§ <strong>Technical Support</strong> â€” Warranty handling, after-sales service, returns processing.<br><br>Which of these interests you most?",
    ['Logistics details', 'Marketing support', 'Become a partner']
  );
}

function handleAbout() {
  botSay(
    "JDM Products was founded in <strong>1999 by Jonathan Moore</strong> and has grown into an award-winning consumer electronics distributor.<br><br>ğŸ“ <strong>HQ:</strong> Unit 9, Ballywaltrim Business Park, Bray, Co. Wicklow, Ireland<br>ğŸ“ <strong>UK Office:</strong> Unit 9 & 10, SignalPark, WestPark, Daventry, NN11 4SA<br><br>Key facts:<br>â€¢ <strong>3,000+</strong> active retail accounts<br>â€¢ Coverage across <strong>Ireland, UK, + 5 EU countries</strong><br>â€¢ <strong>15+</strong> leading technology brands<br>â€¢ Regional sales teams across UK and Ireland<br>â€¢ Award-winning distributor<br>â€¢ B2B portal: <a href=\"https://b2b.jdmproducts.com\" target=\"_blank\">b2b.jdmproducts.com</a><br><br>We're your one-stop shop for consumer electronics distribution â€” from logistics to marketing support.",
    ['Our brands', 'Become a partner', 'Contact us']
  );
}

function handleRegional() {
  let resp = "Our core markets are <strong>Ireland</strong> and the <strong>UK</strong>, where we have warehouse facilities and dedicated regional sales teams. In 2022 we expanded into <strong>5 additional EU countries</strong>, and our European network continues to grow.";

  if (CTX.userLocation) {
    const r = CTX.userLocation.region;
    const p = CTX.userLocation.place;
    if (r === 'Ireland') resp += `<br><br>We have excellent coverage in ${p.charAt(0).toUpperCase() + p.slice(1)} with fast delivery from our Bray facility.`;
    else if (r === 'UK') resp += `<br><br>We cover ${p.charAt(0).toUpperCase() + p.slice(1)} from our Daventry facility with 1-3 day delivery.`;
    else resp += `<br><br>We're expanding our EU coverage and would be happy to discuss distribution in your region.`;
  }

  botSay(resp, ['Delivery times', 'Become a partner', 'Contact regional manager']);
}

function handleContact() {
  botSay(
    "You can reach the JDM team directly:<br><br>ğŸ“ <strong>Ireland:</strong> 01 2050500<br>ğŸ“ <strong>UK:</strong> 0203 4815711<br>ğŸ“§ <strong>Email:</strong> <a href=\"mailto:sales@jdmproducts.com\">sales@jdmproducts.com</a><br>ğŸŒ <strong>Website:</strong> <a href=\"https://jdmproducts.com\" target=\"_blank\">jdmproducts.com</a><br>ğŸ”‘ <strong>B2B Portal:</strong> <a href=\"https://b2b.jdmproducts.com\" target=\"_blank\">b2b.jdmproducts.com</a><br><br>Or I can take your details and have the right team member reach out to you.",
    ['Have someone call me', 'That\'s all I needed']
  );
}

function handleUrgent() {
  botSay(
    "I understand this is time-sensitive. For the fastest response, call us directly:<br><br>ğŸ“ <strong>Ireland:</strong> 01 2050500<br>ğŸ“ <strong>UK:</strong> 0203 4815711<br><br>Alternatively, share your details here and I'll flag it as <strong>priority</strong> so our team picks it up immediately.",
    ['Share my details', 'I\'ll call now']
  );
}

function handleFrustrated(text) {
  botSay(
    "I'm sorry you're experiencing issues. Let me make sure we get this sorted for you right away.<br><br>ğŸ“ For immediate help, call us:<br>â€¢ Ireland: 01 2050500<br>â€¢ UK: 0203 4815711<br><br>Or tell me more about the issue and I'll connect you with the right person.",
    ['Share details', 'I\'ll call now']
  );
}

function handleBuyingSignal(text) {
  if (CTX.customerStatus === 'existing') {
    botSay("I'd be happy to help! Your account manager can provide detailed information. Would you like me to have them reach out, or is there something specific I can answer now?", ['Have them call me', 'I have a question']);
  } else {
    botSay("We'd love to help! To make sure I connect you with the right person, could you tell me a bit about your business? What type of retail operation are you running?", ['Sports / Fitness', 'Electronics', 'Online Retail', 'Other']);
    STATE.flow = 'retailer';
    STATE.flowStep = 0;
    STATE.leadData = { inquiry: text };
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OBJECTION HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleObjectionExistingDistributor() {
  let resp = "That's great that you have an existing relationship! Many of our 3,000+ retail partners work with multiple distributors â€” each brings different brands and strengths.<br><br>JDM's particular strengths are:<br>â€¢ <strong>Exclusive brands</strong> like Garmin (official distributor since 2015)<br>â€¢ <strong>Local stock</strong> = faster delivery than importing<br>â€¢ <strong>Strong marketing support</strong><br>â€¢ <strong>Multi-brand ordering</strong> (one order, multiple brands)";

  if (CTX.mentionedBrands.length) {
    const names = CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ');
    resp += `<br><br>If you're looking specifically for <strong>${names}</strong>, we're one of the leading distributors for those in Ireland/UK.`;
  }

  resp += "<br><br>Even if you're happy with your current setup, it might be worth a conversation about complementing what you already have.";
  botSay(resp, ['Tell me more', 'Not right now']);
}

function handleObjectionPrice() {
  let resp = "I appreciate that price is important for your margins. Our pricing varies significantly based on:<br><br>â€¢ Order volume (larger orders = better pricing)<br>â€¢ Payment terms<br>â€¢ Account history and relationship<br>â€¢ Product mix";

  resp += "<br><br>Also consider the total value beyond unit price:<br>â€¢ Local stock = no long lead times or large prepayments<br>â€¢ Marketing support included<br>â€¢ Warranty handling<br>â€¢ 1-3 day delivery<br><br>What volumes are you typically ordering? I can have our team review options that might work for your business.";
  botSay(resp, ['Discuss volumes', 'Not right now']);
}

function handleObjectionDirect() {
  let resp = "That's certainly an option for very large volumes!<br><br>Most retailers find working with a distributor like JDM more efficient because:<br><br>ğŸ’° <strong>Lower Minimums:</strong> Manufacturers often require container-loads; we break bulk<br>ğŸ“¦ <strong>Local Stock:</strong> Next-day delivery vs weeks from overseas<br>ğŸ¯ <strong>Multi-Brand:</strong> Order Garmin, Fitbit, Tonies in one transaction<br>ğŸ’³ <strong>Better Terms:</strong> Net 30/60 vs prepayment for imports<br>ğŸ“ <strong>Local Support:</strong> We handle warranty, returns, technical queries<br>ğŸ“Š <strong>Marketing:</strong> We provide POS materials and marketing support";

  if (CTX.businessType) {
    resp += `<br><br>For ${CTX.businessType} businesses, the flexibility usually outweighs any small price difference.`;
  }

  resp += "<br><br>Many of our retail partners tried direct importing but came back to us for the convenience. Want to discuss what works best for your scale?";
  botSay(resp, ['Let\'s discuss', 'Good to know']);
}

function handleObjectionPriceMatch() {
  let resp = "I can't speak to specific competitor pricing, but we're very competitive across our brands.<br><br>A few things to consider beyond unit price:<br><br>âœ… <strong>Stock availability</strong> â€” Do they have local stock or long lead times?<br>âœ… <strong>Payment terms</strong> â€” What terms do they offer?<br>âœ… <strong>Support level</strong> â€” Marketing support and training?<br>âœ… <strong>Delivery speed</strong> â€” How quickly can they deliver?<br>âœ… <strong>Warranty handling</strong> â€” Who deals with returns?";

  if (CTX.mentionedBrands.length) {
    const names = CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ');
    resp += `<br><br>For <strong>${names}</strong> specifically, we're one of the official distributors, so our pricing is manufacturer-approved.`;
  }

  resp += "<br><br>Let me connect you with our team who can put together a complete package comparison.";
  botSay(resp, ['Connect me with sales', 'I\'ll think about it']);
}

function handleObjectionThinkAboutIt() {
  let resp = "Absolutely, take your time! This is an important decision for your business.";

  if (CTX.topicsDiscussed.length) {
    resp += `<br><br>We've covered ${CTX.topicsDiscussed.join(', ')} â€” if any of those raise questions later, just come back.`;
  }

  resp += "<br><br>A few things that might help your decision:<br>â€¢ No obligation to talk with our sales team â€” just an exploratory conversation<br>â€¢ We work with retailers of all sizes<br>â€¢ Many partners start small and expand as they see results";

  if (CTX.businessType && CTX.userLocation) {
    resp += `<br><br>We have quite a few ${CTX.businessType} partners in the ${CTX.userLocation.place} area who've been very happy.`;
  }

  resp += "<br><br>Would it help if I sent you some information via email?";
  botSay(resp, ['Yes, send info', 'I\'ll come back later']);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPECIAL HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleAffirmative(text) {
  // Context-dependent "yes" response
  const lastTopic = CTX.topicsDiscussed[CTX.topicsDiscussed.length - 1];

  if (lastTopic === 'pricing' || lastTopic === 'stock') {
    startLeadFlow('Follow-up on ' + lastTopic);
  } else if (CTX.customerStatus === 'prospect' || !CTX.customerStatus) {
    startLeadFlow('General interest');
  } else {
    botSay("Great! What would you like to know more about?", ['Our Brands', 'Pricing', 'Delivery', 'Become a Partner']);
  }
}

function handleOffTopic() {
  botSay(
    "Ha! I'm specifically here to help with JDM Products and our electronics distribution services.<br><br>I can help you with:<br>â€¢ Our brands (Garmin, Fitbit, Tonies, etc.)<br>â€¢ Becoming a retail partner<br>â€¢ Stock and ordering<br>â€¢ Account support<br><br>What brings you to JDM today?",
    ['Our Brands', 'Become a Partner', 'Just Browsing']
  );
}

function handleDemoQuestion() {
  botSay(
    "Great question! This is a demonstration interface showing how our chatbot works. The production version connects to our full AI system which:<br><br>â€¢ Maintains complete conversation context<br>â€¢ Accesses real-time stock data<br>â€¢ Handles any question about your specific needs<br>â€¢ Integrates with our CRM and support systems<br>â€¢ Provides personalised responses based on your account history<br><br>Would you like to learn more about the full system?",
    ['Tell me more', 'Back to browsing']
  );
}

function handleFallback(text) {
  // Try to be helpful based on what we can detect
  const brand = detectBrand(text);
  if (brand) { handleSpecificBrand(brand); return; }

  // Level 2 - guide them
  botSay(
    "I want to make sure you get accurate information rather than guessing. Let me point you in the right direction.<br><br>Are you asking about:<br>â€¢ Products and brands we distribute<br>â€¢ Becoming a retail partner<br>â€¢ Orders and delivery (existing customers)<br>â€¢ Technical support<br>â€¢ Something else<br><br>The more I understand, the better I can help!",
    ['Products & Brands', 'Become a Partner', 'Existing Customer Help', 'Contact Us']
  );
}

</script>
</body>
</html>
