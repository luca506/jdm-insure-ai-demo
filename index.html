<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDM Products - AI Chatbot Demo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: #0a0a1a;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
}

#site-bg {
  position: fixed; inset: 0;
  width: 100%; height: 100%;
  z-index: 0;
  object-fit: cover;
  object-position: top center;
}

/* â”€â”€ Chat Bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-bubble {
  position: fixed; bottom: 28px; right: 28px; z-index: 1000;
  width: 64px; height: 64px; border-radius: 50%;
  background: #111a6e;
  box-shadow: 0 4px 24px rgba(17,26,110,.5);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: transform .2s, box-shadow .2s;
  border: none; outline: none;
}
#chat-bubble:hover { transform: scale(1.08); box-shadow: 0 6px 32px rgba(17,26,110,.6); }
#chat-bubble svg { width: 30px; height: 30px; fill: #fff; }
#chat-bubble .close-icon { display: none; }
#chat-bubble.open .chat-icon { display: none; }
#chat-bubble.open .close-icon { display: block; }

.unread-badge {
  position: absolute; top: -2px; right: -2px;
  width: 20px; height: 20px; background: #e63946;
  border-radius: 50%; color: #fff; font-size: 11px;
  font-weight: 700; display: flex; align-items: center; justify-content: center;
  border: 2px solid #fff;
  animation: pulse-badge 2s infinite;
}
@keyframes pulse-badge {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}
.unread-badge.hidden { display: none; }

/* â”€â”€ Chat Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-window {
  position: fixed; bottom: 104px; right: 28px; z-index: 999;
  width: 24rem; height: 44rem; max-height: calc(100vh - 130px);
  background: #fff; border-radius: 16px;
  box-shadow: 0 12px 48px rgba(0,0,0,.2);
  display: flex; flex-direction: column;
  transform: scale(0) translateY(20px);
  transform-origin: bottom right;
  opacity: 0; pointer-events: none;
  transition: transform .3s cubic-bezier(.175,.885,.32,1.275), opacity .2s;
  overflow: hidden;
}
#chat-window.open {
  transform: scale(1) translateY(0);
  opacity: 1; pointer-events: auto;
}

/* â”€â”€ Chat Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-header {
  background: linear-gradient(135deg, #111a6e, #1a237e);
  color: #fff; padding: 18px 20px;
  display: flex; align-items: center; gap: 14px;
  flex-shrink: 0;
}
.agent-avatar {
  width: 44px; height: 44px; border-radius: 50%;
  background: rgba(255,255,255,.2); display: flex;
  align-items: center; justify-content: center;
  font-size: 20px; font-weight: 700; flex-shrink: 0;
  border: 2px solid rgba(255,255,255,.3);
}
.agent-info h3 { font-size: 15px; font-weight: 700; letter-spacing: .2px; }
.agent-info p { font-size: 11.5px; opacity: .85; margin-top: 2px; }
.online-dot {
  width: 8px; height: 8px; background: #4ade80;
  border-radius: 50%; display: inline-block; margin-right: 5px;
  box-shadow: 0 0 6px rgba(74,222,128,.6);
}

/* â”€â”€ Chat Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-messages {
  flex: 1; overflow-y: auto; padding: 20px;
  display: flex; flex-direction: column; gap: 10px;
  background: #f7f8fa;
  scroll-behavior: smooth;
}
.chat-messages::-webkit-scrollbar { width: 5px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

.msg {
  max-width: 85%; padding: 11px 15px;
  border-radius: 16px; font-size: 13.5px; line-height: 1.55;
  animation: msgIn .3s ease-out;
  word-wrap: break-word;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.msg.bot {
  align-self: flex-start;
  background: #fff; color: #333;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.msg.user {
  align-self: flex-end;
  background: #111a6e; color: #fff;
  border-bottom-right-radius: 4px;
}
.msg a { color: #111a6e; font-weight: 600; text-decoration: underline; }
.msg.user a { color: #c5caff; }

/* â”€â”€ Typing Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.typing-indicator {
  align-self: flex-start;
  display: flex; gap: 5px; padding: 14px 18px;
  background: #fff; border-radius: 16px;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.typing-indicator span {
  width: 7px; height: 7px; background: #bbb; border-radius: 50%;
  animation: blink 1.4s infinite both;
}
.typing-indicator span:nth-child(2) { animation-delay: .2s; }
.typing-indicator span:nth-child(3) { animation-delay: .4s; }
@keyframes blink {
  0%,80%,100% { opacity: .3; transform: scale(.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* â”€â”€ Chat Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-input-area {
  padding: 12px 14px; background: #fff;
  border-top: 1px solid #eee; display: flex; gap: 8px;
  align-items: center; flex-shrink: 0;
}
.chat-input-area input {
  flex: 1; padding: 11px 15px; border: 1.5px solid #ddd;
  border-radius: 24px; font-size: 13.5px; outline: none;
  transition: border-color .2s;
  font-family: inherit;
}
.chat-input-area input:focus { border-color: #111a6e; }
.chat-input-area button {
  width: 40px; height: 40px; border-radius: 50%;
  background: #111a6e; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background .15s;
  flex-shrink: 0;
}
.chat-input-area button:hover { background: #1a237e; }
.chat-input-area button svg { width: 17px; height: 17px; fill: #fff; }

.powered-by {
  text-align: center; padding: 6px; background: #fafafa;
  font-size: 10px; color: #aaa; border-top: 1px solid #f0f0f0;
  flex-shrink: 0;
}

/* â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  #chat-window {
    width: calc(100vw - 16px); right: 8px; bottom: 96px;
    max-height: calc(100vh - 120px);
    height: calc(100vh - 120px);
    border-radius: 12px;
  }
}
</style>
</head>
<body>

<img id="site-bg" src="screenshot.png" alt="JDM Products Website" />

<button id="chat-bubble" onclick="toggleChat()" aria-label="Open chat">
  <svg class="chat-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/><path d="M7 9h10v2H7zm0-3h10v2H7zm0 6h7v2H7z"/></svg>
  <svg class="close-icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
  <div class="unread-badge" id="unread-badge">1</div>
</button>

<div id="chat-window">
  <div class="chat-header">
    <div class="agent-avatar">M</div>
    <div class="agent-info">
      <h3>Michael</h3>
      <p><span class="online-dot"></span>Online</p>
    </div>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-area">
    <input type="text" id="chat-input" placeholder="Type your message..." autocomplete="off" />
    <button onclick="sendMessage()" aria-label="Send"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </div>
  <div class="powered-by">Powered by braind AI &middot; Demo</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JDM INTELLIGENT CHATBOT â€” FULL KNOWLEDGE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Conversation State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CTX = {
  userLocation: null,
  businessType: null,
  customerStatus: null,
  mentionedBrands: [],
  topicsDiscussed: [],
  contactName: null,
  businessName: null,
  email: null,
  phone: null,
  sentiment: 'neutral'
};

const STATE = {
  open: false,
  greeted: false,
  flow: null,
  flowStep: 0,
  leadData: {},
  lastActivity: Date.now(),
  timeoutFired: false,
  meaningfulInteractions: 0,
  leadOffered: false
};

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $msgs = document.getElementById('chat-messages');
const $input = document.getElementById('chat-input');
const $window = document.getElementById('chat-window');
const $bubble = document.getElementById('chat-bubble');
const $badge = document.getElementById('unread-badge');

// â”€â”€ Brand Knowledge Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BRAND_DB = {
  // â”€â”€ FITNESS & WELLNESS â”€â”€
  garmin: {
    name: 'Garmin', cat: 'Fitness & Wellness', since: 2015, official: true,
    categories: ['fitness','outdoor','marine','automotive','golf'],
    desc: "Garmin is one of our flagship brands â€” we've been their official distributor for Ireland and UK since 2015. We carry their full range:<br><br>â€¢ Fitness & wellness (watches, activity trackers)<br>â€¢ Outdoor (hiking, camping GPS devices)<br>â€¢ Marine (boat navigation)<br>â€¢ Automotive (sat navs)<br>â€¢ Golf (rangefinders, GPS)",
    fitFor: { sports: 'fitness range', electronics: 'full tech range', outdoor: 'outdoor and hiking GPS range', online: 'full catalogue' }
  },
  fitbit: {
    name: 'Fitbit', cat: 'Fitness & Wellness',
    categories: ['wellness','fitness tracking'],
    desc: "Fitbit is a strong wellness brand in our portfolio. Their smartwatches and fitness trackers appeal to health-conscious consumers.",
    fitFor: { sports: 'Fitbit is a natural fit alongside Garmin for your fitness customers', electronics: 'wellness wearables are a growing category', online: 'strong online demand for fitness wearables' }
  },
  amazfit: {
    name: 'Amazfit', cat: 'Fitness & Wellness',
    categories: ['smartwatches','fitness tracking'],
    desc: "Amazfit offers affordable smartwatches and fitness trackers with strong battery life and feature sets â€” a popular choice for value-conscious consumers.",
    fitFor: { sports: 'great value fitness option alongside Garmin and Fitbit', electronics: 'affordable wearable range with strong margins', online: 'strong online demand for budget-friendly smartwatches' }
  },
  withings: {
    name: 'Withings', cat: 'Fitness & Wellness',
    categories: ['health monitoring','smart scales','wellness'],
    desc: "Withings specialises in health monitoring devices â€” smart scales, blood pressure monitors, and health watches. A premium brand for health-conscious consumers.",
    fitFor: { sports: 'health monitoring complements fitness wearables', electronics: 'premium health tech is a growing category' }
  },
  echelon: {
    name: 'Echelon', cat: 'Fitness & Wellness',
    categories: ['fitness equipment','connected fitness'],
    desc: "Echelon offers connected fitness equipment â€” smart bikes, rowers, and more. They're growing rapidly in the home fitness market.",
    fitFor: { sports: 'works well alongside Garmin and Fitbit for a complete fitness offering', fitness: 'a strong complement to your fitness range' }
  },
  hyperice: {
    name: 'Hyperice', cat: 'Fitness & Wellness',
    categories: ['recovery','wellness','massage'],
    desc: "Hyperice provides cutting-edge recovery and wellness technology â€” percussion massagers, vibrating foam rollers, and more. Used by professional athletes and everyday consumers alike.",
    fitFor: { sports: 'ideal alongside fitness wearables for a complete wellness offering', fitness: 'recovery tech is a fast-growing segment' }
  },
  beurer: {
    name: 'Beurer', cat: 'Fitness & Wellness',
    categories: ['health','wellbeing','personal care'],
    desc: "Beurer offers a wide range of health and wellbeing products â€” from blood pressure monitors and thermometers to massage devices and personal care.",
    fitFor: { home: 'personal care and health products complement your home range', electronics: 'health tech is in growing demand' }
  },

  // â”€â”€ AUDIO & ENTERTAINMENT â”€â”€
  shokz: {
    name: 'Shokz', cat: 'Audio & Entertainment',
    categories: ['headphones','bone conduction','audio'],
    desc: "Shokz (formerly AfterShokz) makes bone conduction headphones â€” ideal for runners, cyclists, and anyone who needs to stay aware of their surroundings while listening. A unique product with a loyal following.",
    fitFor: { sports: 'perfect for your fitness and outdoor customers', electronics: 'unique audio product with strong margins', online: 'strong online demand from runners and cyclists' }
  },
  buddyphones: {
    name: 'BuddyPhones', cat: 'Audio & Entertainment',
    categories: ['children','headphones','audio'],
    desc: "BuddyPhones makes safe, volume-limited headphones designed specifically for children. Popular with parents looking for quality kids' audio.",
    fitFor: { children: 'a natural fit for your family and kids range', electronics: "children's headphones are a popular gifting category" }
  },
  storyphones: {
    name: 'StoryPhones', cat: 'Audio & Entertainment',
    categories: ['children','audio','storytelling'],
    desc: "StoryPhones is an innovative audio storytelling system for children â€” screen-free entertainment that parents love. A companion product to BuddyPhones.",
    fitFor: { children: 'pairs well with BuddyPhones for a kids audio offering' }
  },
  onanoff: {
    name: 'Onanoff', cat: 'Audio & Entertainment',
    categories: ['audio','headphones'],
    desc: "Onanoff produces quality audio products, including headphones and audio accessories across multiple categories."
  },
  tonies: {
    name: 'Tonies', cat: 'Audio & Entertainment',
    categories: ['children','audio','entertainment'],
    desc: "Tonies is a unique children's audio entertainment system â€” very popular with parents of young kids. The Toniebox and character figures are consistently strong sellers.",
    fitFor: { children: "ideal for your customer base", toy: "Tonies is one of the hottest products in the toy space", family: "families love Tonies" }
  },

  // â”€â”€ SMART HOME & APPLIANCES â”€â”€
  aeno: {
    name: 'AENO', cat: 'Smart Home & Appliances',
    categories: ['smart home','appliances'],
    desc: "AENO provides smart home appliances â€” a growing category that appeals to tech-savvy consumers looking to upgrade their homes.",
    fitFor: { home: 'AENO smart home products complement your lifestyle range', electronics: 'smart home is a fast-growing category' }
  },
  'mill heating': {
    name: 'Mill Heating', cat: 'Smart Home & Appliances',
    categories: ['smart heaters','heating','smart home'],
    desc: "Mill Heating produces smart, energy-efficient heaters with app control. With rising energy costs, smart heating is an increasingly popular category."
  },
  philips: {
    name: 'Philips', cat: 'Smart Home & Appliances',
    categories: ['consumer electronics','smart home','personal care'],
    desc: "Philips is a globally recognised brand â€” we distribute selected Philips consumer electronics products across Ireland and the UK."
  },
  igloohome: {
    name: 'Igloohome', cat: 'Smart Home & Appliances',
    categories: ['smart locks','security','smart home'],
    desc: "Igloohome offers smart locks and access solutions â€” a growing category driven by smart home adoption and the short-term rental market.",
    fitFor: { home: 'smart locks fit well in a home/lifestyle offering', electronics: 'smart security is in high demand' }
  },

  // â”€â”€ GAMING & PC â”€â”€
  razer: {
    name: 'Razer', cat: 'Gaming & PC',
    categories: ['gaming','peripherals','accessories'],
    desc: "Razer is a leading global gaming brand â€” we distribute their peripherals and accessories including keyboards, mice, headsets, and more.",
    fitFor: { gaming: 'Razer is one of the most recognised names in gaming', electronics: 'gaming peripherals are a high-margin category' }
  },
  corsair: {
    name: 'Corsair', cat: 'Gaming & PC',
    categories: ['gaming','pc hardware','peripherals'],
    desc: "Corsair produces PC gaming hardware and peripherals â€” a premium brand with a loyal enthusiast following.",
    fitFor: { gaming: 'pairs perfectly with Razer for a complete gaming offering', electronics: 'strong demand from the PC gaming community' }
  },
  steelseries: {
    name: 'SteelSeries', cat: 'Gaming & PC',
    categories: ['gaming','peripherals'],
    desc: "SteelSeries makes gaming peripherals â€” headsets, keyboards, mice, and controllers trusted by professional esports players.",
    fitFor: { gaming: 'one of the top names in esports and competitive gaming' }
  },
  hyperx: {
    name: 'HyperX', cat: 'Gaming & PC',
    categories: ['gaming','headsets','accessories'],
    desc: "HyperX provides gaming headsets and accessories known for comfort and audio quality. A popular brand across casual and competitive gamers.",
    fitFor: { gaming: 'complements Razer and SteelSeries for a full gaming range' }
  },
  'surefire gaming': {
    name: 'SureFire Gaming', cat: 'Gaming & PC',
    categories: ['gaming','accessories'],
    desc: "SureFire Gaming offers a range of gaming accessories including headsets, keyboards, mice, and more."
  },

  // â”€â”€ PROJECTORS & DISPLAYS â”€â”€
  xgimi: {
    name: 'XGIMI', cat: 'Projectors & Displays',
    categories: ['projectors','smart projectors','displays'],
    desc: "XGIMI makes smart projectors for home cinema, portable use, and business. An exciting category with growing consumer interest.",
    fitFor: { electronics: 'projectors are a growing home entertainment segment', home: 'great for a home cinema and lifestyle offering' }
  },

  // â”€â”€ OUTDOOR & BBQ â”€â”€
  blackstone: {
    name: 'Blackstone Products', cat: 'Outdoor & BBQ',
    categories: ['BBQ','griddles','outdoor cooking'],
    desc: "Blackstone Products specialises in BBQ griddles and outdoor cooking equipment. We have exclusive UK distribution for their range."
  },
  meater: {
    name: 'Meater', cat: 'Outdoor & BBQ',
    categories: ['smart thermometer','BBQ','cooking'],
    desc: "Meater makes smart wireless meat thermometers â€” a clever crossover between tech and outdoor cooking. Popular with BBQ enthusiasts.",
    fitFor: { home: 'great kitchen/cooking crossover product', electronics: 'smart kitchen tech is a growing niche' }
  },

  // â”€â”€ TECH ACCESSORIES â”€â”€
  austere: {
    name: 'Austere', cat: 'Tech Accessories',
    categories: ['premium cables','accessories'],
    desc: "Austere produces premium cables and accessories â€” high-quality, beautifully designed products that offer great margins for retailers."
  },
  rivacase: {
    name: 'Rivacase', cat: 'Tech Accessories',
    categories: ['cases','bags','tech accessories'],
    desc: "Rivacase offers tech cases and bags â€” laptop bags, tablet cases, camera bags, and more. A practical accessory range for tech-focused retailers."
  },
  sbs: {
    name: 'SBS', cat: 'Tech Accessories',
    categories: ['mobile accessories','cables','chargers'],
    desc: "SBS provides mobile accessories including chargers, cables, screen protectors, and more. A high-volume accessory brand."
  },
  tile: {
    name: 'Tile', cat: 'Tech Accessories',
    categories: ['bluetooth tracker','accessories'],
    desc: "Tile makes Bluetooth trackers that help people find lost items â€” keys, bags, wallets. A well-known brand in the item-finding category.",
    fitFor: { electronics: 'great impulse-purchase accessory near checkout', online: 'consistently strong online seller' }
  },

  // â”€â”€ POWER & ENERGY â”€â”€
  jackery: {
    name: 'Jackery', cat: 'Power & Energy',
    categories: ['portable power','solar','energy'],
    desc: "Jackery produces portable power stations and solar panels â€” ideal for outdoor adventures, camping, and emergency backup power. A rapidly growing category.",
    fitFor: { outdoor: 'perfect for your outdoor and adventure customers', electronics: 'portable power is one of the fastest growing tech categories' }
  },
  co2you: {
    name: 'CO2YOU', cat: 'Power & Energy',
    categories: ['sustainable','eco','green tech'],
    desc: "CO2YOU offers sustainable products focused on reducing carbon footprint â€” part of the growing eco-tech movement."
  },

  // â”€â”€ PHOTOGRAPHY â”€â”€
  easypix: {
    name: 'Easypix', cat: 'Photography',
    categories: ['action cameras','photography'],
    desc: "Easypix makes action cameras and photography products â€” an affordable alternative for consumers wanting to capture outdoor activities."
  },

  // â”€â”€ CHILDREN'S TECH â”€â”€
  myfirst: {
    name: 'myFirst', cat: "Children's Tech",
    categories: ['children','smartwatch','tech'],
    desc: "myFirst offers children's tech products including kids' smartwatches, cameras, and headphones â€” safe, fun tech designed specifically for young users.",
    fitFor: { children: 'a natural addition to your kids range alongside Tonies and BuddyPhones' }
  },

  // â”€â”€ E-READERS â”€â”€
  pocketbook: {
    name: 'PocketBook', cat: 'E-Readers',
    categories: ['e-readers','digital reading'],
    desc: "PocketBook makes e-readers â€” an alternative to Kindle with open format support. Popular with avid readers who want format flexibility."
  },

  // â”€â”€ COMPUTING â”€â”€
  'thomson computing': {
    name: 'Thomson Computing', cat: 'Computing',
    categories: ['laptops','tablets','computing'],
    desc: "Thomson Computing offers laptops and tablets at accessible price points â€” ideal for education, basic computing, and budget-conscious buyers."
  },

  // â”€â”€ PAYMENTS â”€â”€
  sumup: {
    name: 'SumUp', cat: 'Payments',
    categories: ['payment terminals','POS','business'],
    desc: "SumUp provides payment terminals and solutions for small businesses â€” enabling card payments with simple, affordable hardware."
  },

  // â”€â”€ SECURITY â”€â”€
  mcafee: {
    name: 'McAfee', cat: 'Security',
    categories: ['cybersecurity','software','antivirus'],
    desc: "McAfee provides cybersecurity software â€” antivirus and internet security solutions that retailers can offer as an add-on to device sales.",
    fitFor: { electronics: 'a high-margin software add-on for any device sale' }
  }
};

const BRAND_ALIASES = {
  // Garmin
  'garman':'garmin','garmen':'garmin','garmon':'garmin','gamin':'garmin',
  // Fitbit
  'fitbt':'fitbit','fitbitt':'fitbit','fit bit':'fitbit','fitbat':'fitbit',
  // Amazfit
  'amazefit':'amazfit','amaze fit':'amazfit','amazefit':'amazfit',
  // Withings
  'withing':'withings','withins':'withings',
  // Tonies
  'tonie':'tonies','tony':'tonies','tonnies':'tonies','tonys':'tonies','toniebox':'tonies',
  // Echelon
  'echelan':'echelon','echellon':'echelon','eschelon':'echelon',
  // Hyperice
  'hyper ice':'hyperice','hyperise':'hyperice',
  // Shokz
  'aftershokz':'shokz','after shokz':'shokz','shocks':'shokz','shox':'shokz',
  // BuddyPhones
  'buddy phones':'buddyphones','buddy phone':'buddyphones','buddyphone':'buddyphones',
  // StoryPhones
  'story phones':'storyphones','storyphone':'storyphones',
  // AENO
  'aneo':'aeno','aino':'aeno','anio':'aeno',
  // Mill Heating
  'mill':'mill heating','mill heat':'mill heating',
  // Igloohome
  'igloo home':'igloohome','igloo':'igloohome',
  // Razer
  'rasor':'razer','razor':'razer',
  // Corsair
  'corsare':'corsair','corseir':'corsair',
  // SteelSeries
  'steel series':'steelseries','steelserie':'steelseries',
  // HyperX
  'hyper x':'hyperx',
  // SureFire Gaming
  'surefire':'surefire gaming','sure fire':'surefire gaming','surefir':'surefire gaming',
  // XGIMI
  'xgmi':'xgimi',
  // Blackstone
  'blackston':'blackstone','black stone':'blackstone',
  // Meater
  'meatter':'meater',
  // Austere
  'austeer':'austere','austre':'austere','austire':'austere',
  // Tile
  'tile tracker':'tile',
  // Jackery
  'jackary':'jackery','jackerey':'jackery',
  // myFirst
  'my first':'myfirst','myfirst tech':'myfirst',
  // PocketBook
  'pocket book':'pocketbook',
  // Thomson Computing
  'thomson':'thomson computing','thompson':'thomson computing','thompson computing':'thomson computing',
  // SumUp
  'sum up':'sumup',
  // McAfee
  'mcaffe':'mcafee','mcaffee':'mcafee','macafee':'mcafee',
  // Rivacase
  'riva case':'rivacase',
  // Easypix
  'easy pix':'easypix'
};

// â”€â”€ Non-JDM brands (for unknown product detection) â”€â”€â”€â”€â”€â”€
const NON_JDM_BRANDS = ['apple','iphone','ipad','macbook','samsung','sony','lg','bose','jbl','panasonic','dell','hp','lenovo','asus','acer','microsoft','xbox','playstation','nintendo','gopro','dji','ring','nest','amazon','alexa','roku','sonos','marshall','beats','sennheiser','google','pixel','dyson','shark','irobot','roomba','instant pot','ninja','breville','kitchenaid','nespresso','keurig','weber','traeger','ooni','oneplus','oppo','huawei','xiaomi','bang and olufsen','bowers and wilkins','hisense','tcl','vizio'];

function detectNonJDMBrand(text) {
  const lower = text.toLowerCase();
  return NON_JDM_BRANDS.some(b => {
    const re = new RegExp('\\b' + b.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\b', 'i');
    return re.test(lower);
  });
}

// â”€â”€ Location detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LOCATIONS_IE = ['dublin','cork','galway','limerick','waterford','kilkenny','bray','wicklow','drogheda','dundalk','sligo','athlone','wexford','carlow','kildare','meath','louth','mayo','donegal','kerry','clare','tipperary','offaly','laois','longford','westmeath','roscommon','leitrim','cavan','monaghan','ireland','irish'];
const LOCATIONS_UK = ['london','manchester','birmingham','leeds','glasgow','edinburgh','liverpool','bristol','sheffield','newcastle','nottingham','leicester','cardiff','belfast','derry','southampton','reading','brighton','cambridge','oxford','york','bath','exeter','norwich','coventry','stoke','wolverhampton','sunderland','derby','swansea','aberdeen','dundee','inverness','england','scotland','wales','northern ireland','uk','united kingdom','britain','british'];
const LOCATIONS_EU = ['france','germany','spain','italy','netherlands','belgium','portugal','austria','sweden','denmark','norway','finland','poland','czech','hungary','romania','greece','europe','european','eu'];

// â”€â”€ Business type detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BIZ_TYPES = {
  sports: ['sport','sports','fitness','gym','athletic','outdoor','running','cycling'],
  electronics: ['electronics','tech','technology','gadget','computer','phone','it store'],
  online: ['online','ecommerce','e-commerce','web','website','amazon','ebay','shopify'],
  department: ['department store','chain','retail chain','supermarket','argos','currys','harvey norman'],
  children: ['children','toy','toys','kids','baby','family','nursery'],
  home: ['home','lifestyle','homeware','interior','furniture','kitchen'],
  gaming: ['gaming','game','games','esports','pc gaming']
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function scrollBottom() {
  setTimeout(() => { $msgs.scrollTop = $msgs.scrollHeight; }, 60);
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function addMsg(html, sender) {
  const d = document.createElement('div');
  d.className = 'msg ' + sender;
  d.innerHTML = html;
  $msgs.appendChild(d);
  scrollBottom();
}

function showTyping() {
  hideTyping();
  const d = document.createElement('div');
  d.className = 'typing-indicator';
  d.id = 'typing';
  d.innerHTML = '<span></span><span></span><span></span>';
  $msgs.appendChild(d);
  scrollBottom();
}

function hideTyping() {
  const t = document.getElementById('typing');
  if (t) t.remove();
}

function botSay(text, delay) {
  const d = delay || Math.min(800 + text.length * 4, 2000);
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMsg(text, 'bot');
  }, d);
}

function match(text, keywords) {
  return keywords.some(k => text.includes(k));
}

function matchWord(text, words) {
  return words.some(w => {
    const re = new RegExp('\\b' + w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\b', 'i');
    return re.test(text);
  });
}

function detectBrand(text) {
  const lower = text.toLowerCase();
  for (const [alias, real] of Object.entries(BRAND_ALIASES)) {
    if (lower.includes(alias)) return real;
  }
  for (const b of Object.keys(BRAND_DB)) {
    if (lower.includes(b)) return b;
  }
  return null;
}

function detectLocation(text) {
  const lower = text.toLowerCase();
  for (const loc of LOCATIONS_IE) {
    if (lower.includes(loc)) return { place: loc, region: 'Ireland' };
  }
  for (const loc of LOCATIONS_UK) {
    if (lower.includes(loc)) return { place: loc, region: 'UK' };
  }
  for (const loc of LOCATIONS_EU) {
    if (lower.includes(loc)) return { place: loc, region: 'EU' };
  }
  return null;
}

function detectBusinessType(text) {
  const lower = text.toLowerCase();
  for (const [type, keywords] of Object.entries(BIZ_TYPES)) {
    if (keywords.some(k => lower.includes(k))) return type;
  }
  return null;
}

function detectSentiment(text) {
  const lower = text.toLowerCase();
  if (match(lower, ['urgent','asap','emergency','immediately','rush','quickly','now','critical'])) return 'urgent';
  if (match(lower, ['frustrated','annoyed','angry','terrible','awful','disappointed','unacceptable','ridiculous','problem','issue','not working','broken','useless'])) return 'frustrated';
  if (match(lower, ['great','excellent','wonderful','fantastic','amazing','love','brilliant','perfect'])) return 'positive';
  return 'neutral';
}

function extractEntities(text) {
  const loc = detectLocation(text);
  if (loc && !CTX.userLocation) {
    CTX.userLocation = loc;
  }
  const biz = detectBusinessType(text);
  if (biz && !CTX.businessType) {
    CTX.businessType = biz;
  }
  const brand = detectBrand(text);
  if (brand && !CTX.mentionedBrands.includes(brand)) {
    CTX.mentionedBrands.push(brand);
  }
  CTX.sentiment = detectSentiment(text);
}

function contextualNote() {
  let note = '';
  if (CTX.businessType && CTX.userLocation) {
    const bt = CTX.businessType.charAt(0).toUpperCase() + CTX.businessType.slice(1);
    const loc = CTX.userLocation.place.charAt(0).toUpperCase() + CTX.userLocation.place.slice(1);
    note = `For ${bt.toLowerCase()} retailers in ${loc}, `;
  } else if (CTX.businessType) {
    const bt = CTX.businessType.charAt(0).toUpperCase() + CTX.businessType.slice(1);
    note = `For ${bt.toLowerCase()} businesses, `;
  } else if (CTX.userLocation) {
    const loc = CTX.userLocation.place.charAt(0).toUpperCase() + CTX.userLocation.place.slice(1);
    note = `For retailers in ${loc}, `;
  }
  return note;
}

function deliveryNote() {
  if (CTX.userLocation) {
    const r = CTX.userLocation.region;
    if (r === 'Ireland') return "For deliveries in Ireland, we typically achieve next-day or 2-day delivery from our Bray facility.";
    if (r === 'UK') return "For UK deliveries, we typically achieve 1-2 day delivery from our Daventry facility.";
    if (r === 'EU') return "For EU deliveries, we typically deliver within 3-7 business days.";
  }
  return '';
}

function brandFit(brandKey) {
  const brand = BRAND_DB[brandKey];
  if (!brand || !brand.fitFor || !CTX.businessType) return '';
  const fit = brand.fitFor[CTX.businessType];
  return fit ? `\n\n${fit}.` : '';
}

function trackTopic(topic) {
  if (!CTX.topicsDiscussed.includes(topic)) {
    CTX.topicsDiscussed.push(topic);
  }
}

function urgentPrefix() {
  if (CTX.sentiment === 'urgent') {
    return "I understand this is time-sensitive. ";
  }
  if (CTX.sentiment === 'frustrated') {
    return "I'm sorry you're experiencing issues â€” let me make sure we get this sorted. ";
  }
  return '';
}

// â”€â”€ Early Lead Capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LEAD_NUDGES = [
  "I can provide much more specific information tailored to your business. Would it help if one of our team reached out? Just need your name and email â€” no obligation.",
  "For more detailed, personalised information, I can have one of our team get in touch. Just a name and email if you're interested.",
  "If you'd like, I can have our team send you detailed information specific to your needs â€” just need a quick email address."
];

function withLeadNudge(text) {
  STATE.meaningfulInteractions++;
  if (STATE.meaningfulInteractions >= 2 && !STATE.leadOffered && CTX.customerStatus !== 'existing' && !STATE.flow) {
    STATE.leadOffered = true;
    const nudge = LEAD_NUDGES[Math.floor(Math.random() * LEAD_NUDGES.length)];
    text += `<br><br>${nudge}`;
  }
  return text;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT TOGGLE & GREETING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleChat() {
  STATE.open = !STATE.open;
  $window.classList.toggle('open', STATE.open);
  $bubble.classList.toggle('open', STATE.open);
  $badge.classList.add('hidden');
  if (STATE.open) {
    $input.focus();
    if (!STATE.greeted) {
      STATE.greeted = true;
      greet();
    }
  }
}

function greet() {
  botSay(
    "Hi there, I'm <strong>Michael</strong> from <strong>JDM Products</strong>. I help retailers with product inquiries, stock availability, and partnership opportunities.<br><br>Whether you're an existing customer, interested in becoming a retail partner, or just exploring â€” I'm here to help. What can I do for you?",
    800
  );
}

// â”€â”€ Inactivity timeout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  if (STATE.open && !STATE.timeoutFired && Date.now() - STATE.lastActivity > 300000) {
    STATE.timeoutFired = true;
    botSay("Still here if you need anything! Feel free to ask a question or I can connect you with our team.");
  }
}, 30000);


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function sendMessage() {
  const text = $input.value.trim();
  if (!text) return;
  $input.value = '';
  handleUserInput(text);
}
$input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

function handleUserInput(raw) {
  addMsg(escHtml(raw), 'user');
  STATE.lastActivity = Date.now();
  STATE.timeoutFired = false;
  const text = raw.toLowerCase().trim();

  // Extract entities from every message
  extractEntities(text);

  // If in a multi-step flow, continue it
  if (STATE.flow) {
    continueFlow(raw, text);
    return;
  }

  // â”€â”€ Intent Detection (priority order) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // 1. Customer status responses
  if (match(text, ['existing customer','current customer','already a customer','i have an account','have account','my account'])) {
    CTX.customerStatus = 'existing';
    handleExistingCustomerWelcome();
    return;
  }
  // Commitment signals â€” user explicitly wants to become a partner
  if (match(text, ['become a retailer','become a partner','become a stockist','open an account','open account','sign up','sign me up','want to sell','want to stock','start selling','stock your products','apply','set up an account','new account','onboard','i want to partner','i\'d like to partner','get started'])) {
    CTX.customerStatus = 'prospect';
    startRetailerFlow();
    return;
  }
  // Informational â€” user is asking about partnerships, not committing yet
  if (match(text, ['partnership','partner with','how to partner','retail partner','stockist','new retailer','new partner','reseller','what partnerships','types of partner','how does partner'])) {
    handlePartnershipInfo();
    return;
  }
  if (match(text, ['just browsing','just looking','browsing','looking around','curious','explore'])) {
    CTX.customerStatus = 'browsing';
    handleBrowsing();
    return;
  }

  // 2. Check for specific brand mention
  const brand = detectBrand(text);
  if (brand) {
    handleSpecificBrand(brand);
    return;
  }

  // 3. Stock / availability
  if (match(text, ['stock','in stock','available','availability','inventory','lead time','out of stock'])) {
    trackTopic('stock');
    handleStock(text);
    return;
  }

  // 4. Pricing
  if (match(text, ['price','pricing','cost','how much','expensive','cheap','rates','margin','margins','wholesale price','price list'])) {
    trackTopic('pricing');
    handlePricing();
    return;
  }

  // 5. Delivery / logistics
  if (match(text, ['delivery','shipping','freight','logistics','deliver','transport','drop ship','dropship','drop shipping','courier','dispatch'])) {
    trackTopic('delivery');
    handleDelivery();
    return;
  }

  // 6. Payment terms
  if (match(text, ['payment terms','net 30','net 60','credit','pay later','invoice','credit terms','payment'])) {
    trackTopic('terms');
    handlePaymentTerms();
    return;
  }

  // 7. Returns & warranty
  if (match(text, ['return','returns','return policy','warranty','faulty','defective','damaged','broken','rma','after-sales','after sales'])) {
    trackTopic('returns');
    handleReturns();
    return;
  }

  // 8. Marketing support
  if (match(text, ['marketing','advertising','social media','pos materials','pos display','point of sale','in-store display','promotional','co-op','co-marketing','brand awareness'])) {
    trackTopic('marketing');
    handleMarketing();
    return;
  }

  // 9. Portal access
  if (match(text, ['portal','login','log in','b2b','online ordering','account access','can\'t log in','cant log in','password','reset password'])) {
    handlePortal();
    return;
  }

  // 10. Minimum order
  if (match(text, ['minimum order','minimum spend','mov','how much minimum','min order'])) {
    trackTopic('minimums');
    handleMinimumOrder();
    return;
  }

  // 11. Brands / product general inquiry
  if (match(text, ['brand','brands','product','products','range','catalogue','catalog','what do you sell','what do you distribute','what do you carry','portfolio'])) {
    handleBrandOverview();
    return;
  }

  // 12. Services general
  if (match(text, ['services','what do you offer','how can you help','support','training','events','trade show'])) {
    handleServices();
    return;
  }

  // 13. Company info / about
  if (match(text, ['about jdm','who is jdm','who are jdm','tell me about jdm','tell me about your company','company','history','founded','who are you','what is jdm','what does jdm do','jonathan moore'])) {
    handleAbout();
    return;
  }

  // 14. Regional / territory
  if (match(text, ['region','country','countries','europe','european','expand','expansion','cover','territory','where do you','coverage','where are you'])) {
    handleRegional();
    return;
  }

  // 15. Contact
  if (match(text, ['contact','phone','call','email','reach','speak to someone','talk to someone','human','real person','agent','call you','your number','phone number'])) {
    handleContact();
    return;
  }

  // 16. Objections
  if (match(text, ['already have a distributor','have a distributor','existing distributor','current distributor','happy with our','already work with'])) {
    handleObjectionExistingDistributor();
    return;
  }
  if (match(text, ['too expensive','too high','prices are high','too costly','cheaper','better price','not competitive'])) {
    handleObjectionPrice();
    return;
  }
  if (match(text, ['buy direct','direct from manufacturer','go direct','manufacturer direct','cut out the middleman'])) {
    handleObjectionDirect();
    return;
  }
  if (match(text, ['match price','price match','competitor','beat the price','match their price'])) {
    handleObjectionPriceMatch();
    return;
  }
  if (match(text, ['think about it','need to think','consider it','not sure yet','maybe later','come back','need time'])) {
    handleObjectionThinkAboutIt();
    return;
  }

  // 17. Greetings
  if (matchWord(text, ['hi','hello','hey','howdy','hiya','yo','sup']) || match(text, ['good morning','good afternoon','good evening'])) {
    botSay("Hello. How can I help you today?");
    return;
  }

  // 18. Thanks
  if (match(text, ['thanks','thank you','cheers','appreciate','thx','tysm']) || matchWord(text, ['ta'])) {
    botSay("You're welcome. Is there anything else I can help with?");
    return;
  }

  // 19. Goodbye
  if (match(text, ['bye','goodbye','that\'s all','no thanks','all good','no that\'s it','see you','take care','nothing else','no more questions','that\'s everything','i\'m good','im good'])) {
    botSay("Thanks for chatting! If you need anything in the future, we're always here. Have a great day. ğŸ‘‹");
    return;
  }

  // 20. Yes / agreement (contextual)
  if (match(text, ['yes please','go ahead','absolutely','definitely']) || matchWord(text, ['yes','yeah','yep','sure','ok','okay','please'])) {
    handleAffirmative(text);
    return;
  }

  // 21. Urgent
  if (CTX.sentiment === 'urgent') {
    handleUrgent();
    return;
  }

  // 22. Frustrated
  if (CTX.sentiment === 'frustrated') {
    handleFrustrated(text);
    return;
  }

  // 23. Buying signals
  if (match(text, ['interested in','looking for','considering','exploring','want to know','tell me more','more info','information'])) {
    handleBuyingSignal(text);
    return;
  }

  // 24. Unknown product / non-JDM brand inquiry
  if (detectNonJDMBrand(text) || match(text, ['do you sell','do you have','do you carry','do you stock','do you supply','can you get','can you supply','can i get','can i buy','can i order'])) {
    handleUnknownProductInquiry(raw);
    return;
  }

  // 25. Off-topic / fun
  if (match(text, ['weather','football','soccer','rugby','gaa','politics','joke','funny','what\'s the time','who are you','are you real','are you ai','are you a bot','chatgpt','gpt'])) {
    handleOffTopic();
    return;
  }

  // 26. Demo question
  if (match(text, ['demo','this a demo','is this real','demonstration','test','full version','production','real version','ai version'])) {
    handleDemoQuestion();
    return;
  }

  // 27. Fallback
  handleFallback(text);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOW HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function continueFlow(raw, text) {
  const f = STATE.flow;
  if (f === 'retailer') continueRetailerFlow(raw, text);
  else if (f === 'lead') continueLeadFlow(raw, text);
  else if (f === 'existingHelp') continueExistingFlow(raw, text);
  else { STATE.flow = null; handleUserInput(raw); }
}

// â”€â”€ Retailer Onboarding Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startRetailerFlow() {
  STATE.flow = 'retailer';
  STATE.flowStep = 0;
  STATE.leadData = {};
  botSay(
    "Excellent â€” let's get that started. JDM works with retail partners of all sizes, from independent shops to major chains.<br><br>To connect you with the right person, what <strong>type of retail business</strong> do you operate? (e.g., sports shop, electronics store, online retailer, department store)"
  );
}

function continueRetailerFlow(raw, text) {
  extractEntities(text);
  const step = STATE.flowStep;

  if (step === 0) {
    STATE.leadData.businessType = raw;
    if (!CTX.businessType) CTX.businessType = detectBusinessType(text) || raw;
    STATE.flowStep = 1;
    botSay("And where are you <strong>located</strong>?");

  } else if (step === 1) {
    STATE.leadData.location = raw;
    if (!CTX.userLocation) {
      const loc = detectLocation(text);
      CTX.userLocation = loc || { place: raw, region: raw };
    }
    STATE.flowStep = 2;
    botSay("Are you currently stocking any <strong>consumer electronics brands</strong>? And do you have a <strong>physical store</strong>, <strong>online presence</strong>, or <strong>both</strong>?");

  } else if (step === 2) {
    STATE.leadData.currentSetup = raw;
    STATE.flowStep = 3;
    botSay("Which of our brands interest you most?");

  } else if (step === 3) {
    STATE.leadData.brandsOfInterest = raw;
    STATE.flowStep = 4;
    const ctx = contextualNote();
    botSay(
      `${ctx ? ctx + 'we see really strong demand. ' : ''}Based on what you've told me, you'd be a strong fit for JDM. Our sales team will reach out within <strong>1-2 business days</strong> to discuss:<br><br>â€¢ Which brands suit your customer base<br>â€¢ Pricing and payment terms<br>â€¢ Marketing support available<br>â€¢ Getting you set up on our portal<br><br>Can I get your <strong>contact details</strong>? Let's start with your <strong>name</strong>.`
    );

  } else if (step === 4) {
    STATE.leadData.contactName = raw;
    CTX.contactName = raw;
    STATE.flowStep = 5;
    botSay(`Thanks, ${escHtml(raw.split(' ')[0])}. What's your <strong>business name</strong>?`);

  } else if (step === 5) {
    STATE.leadData.businessName = raw;
    CTX.businessName = raw;
    STATE.flowStep = 6;
    botSay("And your <strong>email address</strong>?");

  } else if (step === 6) {
    STATE.leadData.email = raw;
    CTX.email = raw;
    STATE.flowStep = 7;
    botSay("And a <strong>phone number</strong> in case our team needs to reach you directly?");

  } else if (step === 7) {
    STATE.leadData.phone = raw;
    CTX.phone = raw;
    STATE.flow = null;
    const name = STATE.leadData.contactName.split(' ')[0];
    const region = CTX.userLocation ? CTX.userLocation.region : 'Ireland/UK';
    const brandNote = CTX.mentionedBrands.length
      ? `They'll have specific information about <strong>${CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ')}</strong> availability and pricing for you.`
      : '';

    botSay(
      `Thank you, <strong>${escHtml(name)}</strong>.<br><br>ğŸ“‹ Here's what happens next:<br>1. Our <strong>${escHtml(region)}</strong> sales manager will review your inquiry<br>2. They'll contact you at <strong>${escHtml(STATE.leadData.email)}</strong> within <strong>1-2 business days</strong><br>3. They'll discuss brands, pricing, terms, and how to get started<br><br>${brandNote}<br><br>In the meantime, feel free to browse or call us:<br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711<br><br>Looking forward to working with you!`
    );
    console.log('[LEAD CAPTURED]', JSON.stringify(STATE.leadData, null, 2));
  }
}

// â”€â”€ Lead Capture (short) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startLeadFlow(context) {
  STATE.flow = 'lead';
  STATE.flowStep = 0;
  STATE.leadData = { inquiry: context || '' };
  botSay("Let me connect you with the right person. Could you share your <strong>name</strong> and <strong>business name</strong>?");
}

function continueLeadFlow(raw, text) {
  const step = STATE.flowStep;
  if (step === 0) {
    STATE.leadData.nameAndBusiness = raw;
    STATE.flowStep = 1;
    botSay("And your <strong>email</strong> and <strong>phone number</strong> so our team can follow up?");
  } else if (step === 1) {
    STATE.leadData.contactInfo = raw;
    STATE.flow = null;
    botSay(
      "Noted â€” I've flagged your inquiry and one of our <strong>sales managers</strong> will reach out within <strong>1-2 business days</strong>.<br><br>You can also call us directly:<br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711<br><br>Anything else I can help with?"
    );
    console.log('[LEAD CAPTURED]', JSON.stringify(STATE.leadData, null, 2));
  }
}

// â”€â”€ Existing Customer Help Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function continueExistingFlow(raw, text) {
  STATE.flow = null;
  extractEntities(text);
  // Re-route back to main handler
  if (match(text, ['stock','order','availability'])) { handleStock(text); }
  else if (match(text, ['portal','login','log in','password'])) { handlePortal(); }
  else if (match(text, ['return','warranty','faulty','broken'])) { handleReturns(); }
  else if (match(text, ['price','pricing','invoice'])) { handlePricing(); }
  else {
    botSay(
      "No problem. For specific account queries, your <strong>dedicated account manager</strong> is the best person to help. You can also reach us at:<br><br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711<br><br>What's your <strong>account name</strong>? I'll have your account manager get in touch."
    );
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOPIC RESPONSE HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleExistingCustomerWelcome() {
  CTX.customerStatus = 'existing';
  STATE.flow = 'existingHelp';
  botSay(
    "I can help you with:<br><br>â€¢ Stock availability and orders<br>â€¢ Portal access issues<br>â€¢ Account inquiries<br>â€¢ Technical support<br>â€¢ Returns and warranty<br><br>What do you need help with today?"
  );
}

function handleBrowsing() {
  CTX.customerStatus = 'browsing';
  botSay(
    "No problem. Feel free to ask me about:<br><br>â€¢ Our 30+ brands (Garmin, Razer, Fitbit, Tonies, and more)<br>â€¢ How to become a JDM retail partner<br>â€¢ Stock and delivery<br>â€¢ Our services and support<br><br>What would you like to know?"
  );
}

function handlePartnershipInfo() {
  trackTopic('partnership');
  let resp = "JDM works with <strong>3,000+ retail partners</strong> across Ireland, UK, and the EU â€” from independent shops to major chains.<br><br>A partnership with JDM means becoming a stockist who buys wholesale from us. We distribute <strong>30+ leading brands</strong> across fitness, audio, gaming, smart home, outdoor, tech accessories, and more.<br><br>As a retail partner, you get:<br>â€¢ Access to our full brand portfolio at wholesale pricing<br>â€¢ 1-3 day delivery from our Ireland and UK facilities<br>â€¢ Flexible payment terms (Net 30/60 for established accounts)<br>â€¢ Marketing support â€” POS materials, co-op marketing, social media content<br>â€¢ Dedicated account manager<br>â€¢ Real-time stock visibility via our B2B portal<br>â€¢ Store-level training and merchandising support";

  if (CTX.businessType) {
    const bt = CTX.businessType;
    const relevantBrands = {
      sports: 'Garmin, Fitbit, Amazfit, Withings, Echelon, Hyperice, and Shokz',
      electronics: 'our full tech range including Razer, Corsair, XGIMI, and more',
      children: 'Tonies, BuddyPhones, StoryPhones, and myFirst',
      gaming: 'Razer, Corsair, SteelSeries, HyperX, and SureFire Gaming',
      home: 'AENO, Mill Heating, Igloohome, and Philips smart home products',
      online: 'our full 30+ brand catalogue with dropship options'
    };
    const brands = relevantBrands[bt] || 'our brand portfolio';
    resp += `<br><br>For ${bt} businesses, ${brands} tend to perform particularly well.`;
  }

  resp += "<br><br>To get started, we typically just need to understand your business â€” type of retail, location, and which brands interest you. Would you like to explore that?";

  botSay(withLeadNudge(resp));
}

function handleBrandOverview() {
  trackTopic('brands');
  let resp = "We distribute <strong>30+ leading brands</strong> across these categories:<br><br>";
  resp += "ğŸ’ª <strong>Fitness & Wellness:</strong> Garmin, Fitbit, Amazfit, Withings, Echelon, Hyperice, Beurer<br><br>";
  resp += "ğŸ§ <strong>Audio & Entertainment:</strong> Shokz, BuddyPhones, StoryPhones, Onanoff, Tonies<br><br>";
  resp += "ğŸ  <strong>Smart Home:</strong> AENO, Mill Heating, Philips, Igloohome<br><br>";
  resp += "ğŸ® <strong>Gaming & PC:</strong> Razer, Corsair, SteelSeries, HyperX, SureFire Gaming<br><br>";
  resp += "ğŸ“½ï¸ <strong>Projectors:</strong> XGIMI<br><br>";
  resp += "ğŸ”¥ <strong>Outdoor & BBQ:</strong> Blackstone, Meater<br><br>";
  resp += "ğŸ”Œ <strong>Tech Accessories:</strong> Austere, Rivacase, SBS, Tile<br><br>";
  resp += "âš¡ <strong>Power & Energy:</strong> Jackery, CO2YOU<br><br>";
  resp += "ğŸ“· <strong>Photography:</strong> Easypix<br><br>";
  resp += "ğŸ‘¶ <strong>Children's Tech:</strong> myFirst<br><br>";
  resp += "ğŸ“– <strong>E-Readers:</strong> PocketBook &nbsp;|&nbsp; ğŸ’» <strong>Computing:</strong> Thomson Computing<br>";
  resp += "ğŸ’³ <strong>Payments:</strong> SumUp &nbsp;|&nbsp; ğŸ”’ <strong>Security:</strong> McAfee<br><br>";
  resp += "If you'd like more detail on any specific brand, just let me know.";
  botSay(withLeadNudge(resp));
}

function handleSpecificBrand(brandKey) {
  trackTopic('brands');
  if (!CTX.mentionedBrands.includes(brandKey)) CTX.mentionedBrands.push(brandKey);

  const brand = BRAND_DB[brandKey];
  if (!brand) {
    let resp = "I don't have detailed information on that specific product right now, but our team can help.";
    resp += "<br><br>Let me pass your inquiry along â€” could you share your <strong>name</strong> and <strong>business name</strong>?";
    STATE.flow = 'lead';
    STATE.flowStep = 0;
    STATE.leadData = { inquiry: brandKey, type: 'unknown_product' };
    botSay(resp);
    return;
  }

  let response = `${brand.desc}`;
  const fit = brandFit(brandKey);
  if (fit) response += fit;

  if (CTX.customerStatus === 'existing') {
    response += `<br><br>For current stock levels and pricing, check the portal at <a href="https://b2b.jdmproducts.com" target="_blank">b2b.jdmproducts.com</a> or contact your account manager.`;
    botSay(response);
  } else {
    response += `<br><br>Would you like to know more about stocking ${brand.name}, or is there anything else I can help with?`;
    botSay(withLeadNudge(response));
  }
}

function handleStock(text) {
  const prefix = urgentPrefix();

  if (CTX.customerStatus === 'existing') {
    let resp = `${prefix}For current stock levels, please log into your account at <a href="https://b2b.jdmproducts.com" target="_blank">b2b.jdmproducts.com</a> where you'll see real-time availability.<br><br>Alternatively, your account manager can provide this immediately.`;
    if (CTX.mentionedBrands.length) {
      resp += ` For <strong>${CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ')}</strong> specifically, we typically maintain strong stock levels.`;
    }
    botSay(resp);
  } else {
    let resp = `${prefix}We maintain significant stock across our Ireland and UK facilities â€” local stock means fast delivery, not weeks from overseas.`;
    if (CTX.mentionedBrands.length) {
      const brandNames = CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ');
      resp += `<br><br>For <strong>${brandNames}</strong>, I can have our sales team provide current stock levels and lead times.`;
    } else {
      resp += `<br><br>Which brand or product are you interested in? I can have our sales team provide current stock levels and lead times.`;
    }
    botSay(withLeadNudge(resp));
  }
}

function handlePricing() {
  const prefix = urgentPrefix();
  let resp = `${prefix}Pricing is tailored to each retail partner based on order volume, relationship, and account terms. We offer competitive wholesale pricing with volume discounts.`;

  if (CTX.businessType) {
    const relevantBrands = {
      sports: 'Garmin, Fitbit, Amazfit, Hyperice, and Echelon',
      electronics: 'our full tech range including Razer, Corsair, Philips, and more',
      children: 'Tonies, BuddyPhones, StoryPhones, and myFirst',
      gaming: 'Razer, Corsair, SteelSeries, and HyperX',
      home: 'AENO, Mill Heating, Igloohome, and Philips smart home products',
      online: 'our full 30+ brand catalogue with dropship options'
    };
    const brands = relevantBrands[CTX.businessType] || 'our brand portfolio';
    resp += `<br><br>For ${CTX.businessType} businesses, we typically see strong margins on ${brands}.`;
  }

  resp += `<br><br>Would you like me to have one of our account managers send you a tailored price list?`;

  if (CTX.customerStatus === 'existing') {
    botSay(resp);
  } else {
    botSay(withLeadNudge(resp));
  }
}

function handleDelivery() {
  const prefix = urgentPrefix();
  let resp = `${prefix}JDM has logistics facilities in both <strong>Ireland</strong> (Bray, Co. Wicklow) and <strong>UK</strong> (Daventry).<br><br>Standard delivery times:<br>â€¢ Ireland: <strong>1-3 business days</strong><br>â€¢ UK: <strong>1-3 business days</strong><br>â€¢ EU: <strong>3-7 business days</strong><br><br>We manage the full freight and transport network, including customs for EU orders.`;

  const dn = deliveryNote();
  if (dn) resp += `<br><br>${dn}`;

  resp += `<br><br>Drop shipping is also available for qualified accounts. Minimum order requirements and delivery costs vary by account type.`;

  botSay(withLeadNudge(resp));
}

function handlePaymentTerms() {
  const prefix = urgentPrefix();
  let resp = `${prefix}JDM offers flexible payment terms for established business accounts:<br><br>â€¢ <strong>Net 30 days</strong><br>â€¢ <strong>Net 60 days</strong> (for larger accounts)<br><br>New retail partners typically start with advance payment or shorter terms, then move to Net terms once a trading relationship is established.<br><br>Credit terms are based on:<br>â€¢ Business size and turnover<br>â€¢ Trading history<br>â€¢ Credit check results`;

  if (CTX.customerStatus === 'prospect' || !CTX.customerStatus) {
    resp += `<br><br>Once you're set up as a JDM partner, we can work out payment terms that suit your cash flow needs.`;
  }

  botSay(withLeadNudge(resp));
}

function handleReturns() {
  const prefix = urgentPrefix();
  let resp = `${prefix}JDM provides comprehensive support for returns and warranties:<br><br>â€¢ <strong>Manufacturer warranty handling</strong> â€” We process warranty claims on behalf of retailers, so you don't deal with manufacturers directly<br>â€¢ <strong>Faulty product returns</strong> â€” Clear processes for defective items<br>â€¢ <strong>Technical support</strong> â€” Our team can help diagnose issues before returns<br><br>Specific return policies depend on the reason:<br>â€¢ Manufacturing defects: Full support under warranty<br>â€¢ Commercial returns: Varies by circumstance<br>â€¢ Damaged in transit: Handled case-by-case`;

  if (CTX.customerStatus === 'existing') {
    resp += `<br><br>Your account manager can walk you through the exact process. What's your account name?`;
    botSay(resp);
  } else {
    resp += `<br><br>Once you're a JDM partner, you'll have dedicated support for all returns and warranty issues.`;
    botSay(withLeadNudge(resp));
  }
}

function handleMarketing() {
  const prefix = urgentPrefix();
  let resp = `${prefix}As a JDM partner, you get access to marketing support across several areas:<br><br>ğŸ“± <strong>Social Media Support:</strong><br>â€¢ Daily content updates featuring our brands<br>â€¢ Co-brandable content you can use<br>â€¢ Product announcements and promotions<br><br>ğŸª <strong>In-Store Support:</strong><br>â€¢ POS materials and displays<br>â€¢ Product demo units (for qualified accounts)<br>â€¢ Shelf talkers and signage<br><br>ğŸ“Š <strong>Marketing Programs:</strong><br>â€¢ Co-op marketing opportunities<br>â€¢ Brand awareness campaigns<br>â€¢ Seasonal promotional support<br><br>ğŸ“ <strong>Training & Events:</strong><br>â€¢ Product training sessions<br>â€¢ Trade show participation<br>â€¢ Consumer events and demos<br><br>This is all included as part of being a JDM partner.`;

  if (CTX.businessType) {
    const support = {
      sports: 'product demo units, fitness-focused POS materials, and brand training for Garmin, Fitbit, Amazfit, and Hyperice',
      electronics: 'tech spec sheets, digital marketing assets, and category management support',
      online: 'product imagery, descriptions, digital content packs, and co-brandable social media assets',
      children: 'Tonies and BuddyPhones display units, seasonal promotional kits, and in-store demo support',
      gaming: 'Razer, Corsair, and SteelSeries POS materials, gaming event support, and demo units'
    };
    const s = support[CTX.businessType];
    if (s) resp += `<br><br>For ${CTX.businessType} businesses, we typically provide ${s}.`;
  }

  botSay(withLeadNudge(resp));
}

function handlePortal() {
  if (CTX.customerStatus === 'existing' || match('', [])) {
    botSay(
      `The JDM partner portal is at: <a href="https://b2b.jdmproducts.com" target="_blank"><strong>b2b.jdmproducts.com</strong></a><br><br>Through the portal you can:<br>â€¢ Check real-time stock availability<br>â€¢ Place orders 24/7<br>â€¢ View order history and tracking<br>â€¢ Make payments<br>â€¢ Download invoices<br><br>Having trouble logging in? Common fixes:<br>â€¢ Forgotten password â€” Use the 'Reset Password' link<br>â€¢ Account not set up â€” Contact your account manager<br>â€¢ Technical issues â€” Clear browser cache or try a different browser<br><br>If you're still stuck, call us:<br>ğŸ“ Ireland: 01 2050500<br>ğŸ“ UK: 0203 4815711`
    );
  } else {
    botSay(
      `Once you're set up as a JDM retail partner, you'll get access to our B2B portal at <a href="https://b2b.jdmproducts.com" target="_blank"><strong>b2b.jdmproducts.com</strong></a> where you can check stock and place orders 24/7.<br><br>Would you like to know more about becoming a partner?`
    );
  }
}

function handleMinimumOrder() {
  let resp = `Minimum order requirements vary depending on:<br>â€¢ Account type and size<br>â€¢ Delivery location<br>â€¢ Payment terms<br><br>Typically:<br>â€¢ <strong>Smaller independent retailers:</strong> Lower minimums to help you get started<br>â€¢ <strong>Larger accounts:</strong> Standard MOVs apply but with better terms<br>â€¢ Free delivery thresholds vary by location`;

  if (CTX.businessType || CTX.userLocation) {
    const loc = CTX.userLocation ? CTX.userLocation.place : 'your area';
    const biz = CTX.businessType || 'your business type';
    resp += `<br><br>For ${biz} retailers in ${loc}, I can have our team provide specific minimums and delivery thresholds.`;
  }

  resp += `<br><br>This is something we work out during account setup based on your business needs.`;
  botSay(withLeadNudge(resp));
}

function handleServices() {
  let resp = "JDM provides end-to-end distribution services â€” not just supply chain, but full sales and service lifecycle management:<br><br>";
  resp += "ğŸ“¦ <strong>Logistics & Fulfilment</strong><br>â€¢ Warehouses in Bray (Ireland), Daventry (UK) and mainland China<br>â€¢ 1-3 day delivery across Ireland and UK<br>â€¢ Serial number tracking, store-level deliveries, and direct-to-consumer shipping<br>â€¢ Returns management and automated forecasting<br><br>";
  resp += "ğŸ“Š <strong>Data Analytics & IT</strong><br>â€¢ Real-time sell-in and stock reports for brand partners<br>â€¢ EDI integration for instant order uploads and same-day dispatch<br>â€¢ B2B portal for 24/7 ordering, tracking, invoices, and returns<br><br>";
  resp += "ğŸ‘¥ <strong>Sales & Account Management</strong><br>â€¢ Regional field-based sales teams across UK and Ireland<br>â€¢ Dedicated account managers for each partner<br>â€¢ New business development and non-traditional market specialists<br>â€¢ 3,000+ active trading accounts<br><br>";
  resp += "ğŸ“¢ <strong>Marketing & Merchandising</strong><br>â€¢ Social media (Facebook, Instagram, Twitter, YouTube, LinkedIn)<br>â€¢ POS materials, in-store displays, category management<br>â€¢ Co-op marketing and brand awareness campaigns<br><br>";
  resp += "ğŸ“ <strong>Training & Events</strong><br>â€¢ Store-level product training nationwide<br>â€¢ Trade shows (B2B) and consumer events (B2C)<br><br>";
  resp += "ğŸ”§ <strong>After-Sales</strong><br>â€¢ Warranty handling, technical support, returns processing<br><br>";
  resp += "Would you like more detail on any of these?";
  botSay(withLeadNudge(resp));
}

function handleAbout() {
  let resp = "JDM Products was founded in <strong>1999 by Jonathan Moore</strong> and has grown into an award-winning consumer electronics distributor.<br><br>";
  resp += "ğŸ“ <strong>HQ:</strong> Unit 9, Ballywaltrim Business Park, Boghall Rd, Bray, Co. Wicklow, Ireland<br>";
  resp += "ğŸ“ <strong>UK Office:</strong> Unit 9 & 10, SignalPark, WestPark, Daventry, NN11 4SA<br>";
  resp += "ğŸ“ <strong>China:</strong> Mainland China facilities<br><br>";
  resp += "Key facts:<br>";
  resp += "â€¢ <strong>3,000+</strong> active retail accounts<br>";
  resp += "â€¢ <strong>30+</strong> leading technology brands<br>";
  resp += "â€¢ Coverage across <strong>Ireland, UK, + 5 EU countries</strong><br>";
  resp += "â€¢ Regional sales teams across UK and Ireland<br>";
  resp += "â€¢ State-of-the-art warehouse management with real-time tracking<br>";
  resp += "â€¢ EDI integration and automated systems<br>";
  resp += "â€¢ WEEE and GDPR compliant<br>";
  resp += "â€¢ B2B portal: <a href=\"https://b2b.jdmproducts.com\" target=\"_blank\">b2b.jdmproducts.com</a><br><br>";
  resp += "Our vision: providing best-in-class logistical services to both retail and supplier partners, continually investing in IT and keeping up with consumer trends.";
  botSay(withLeadNudge(resp));
}

function handleRegional() {
  let resp = "Our core markets are <strong>Ireland</strong> and the <strong>UK</strong>, where we have warehouse facilities and dedicated regional sales teams. We also have facilities in <strong>mainland China</strong> for sourcing. In 2022 we expanded into <strong>5 additional EU countries</strong>, and our European network continues to grow.";

  if (CTX.userLocation) {
    const r = CTX.userLocation.region;
    const p = CTX.userLocation.place;
    if (r === 'Ireland') resp += `<br><br>We have excellent coverage in ${p.charAt(0).toUpperCase() + p.slice(1)} with fast delivery from our Bray facility.`;
    else if (r === 'UK') resp += `<br><br>We cover ${p.charAt(0).toUpperCase() + p.slice(1)} from our Daventry facility with 1-3 day delivery.`;
    else resp += `<br><br>We're expanding our EU coverage and would be happy to discuss distribution in your region.`;
  }

  botSay(withLeadNudge(resp));
}

function handleContact() {
  botSay(
    "You can reach the JDM team directly:<br><br>ğŸ“ <strong>Ireland:</strong> 01 2050500<br>ğŸ“ <strong>UK:</strong> 0203 4815711<br>ğŸ“§ <strong>Email:</strong> <a href=\"mailto:sales@jdmproducts.com\">sales@jdmproducts.com</a><br>ğŸŒ <strong>Website:</strong> <a href=\"https://jdmproducts.com\" target=\"_blank\">jdmproducts.com</a><br>ğŸ”‘ <strong>B2B Portal:</strong> <a href=\"https://b2b.jdmproducts.com\" target=\"_blank\">b2b.jdmproducts.com</a><br><br>ğŸ“± <strong>Social Media:</strong><br>â€¢ Instagram: <a href=\"https://instagram.com/jdmproductsltd\" target=\"_blank\">@jdmproductsltd</a><br>â€¢ Facebook: <a href=\"https://facebook.com/jdmproductsltd\" target=\"_blank\">/jdmproductsltd</a><br>â€¢ LinkedIn: <a href=\"https://linkedin.com/company/jdm-products\" target=\"_blank\">/company/jdm-products</a><br><br>Or I can take your details and have the right team member reach out to you."
  );
}

function handleUrgent() {
  botSay(
    "I understand this is time-sensitive. For the fastest response, call us directly:<br><br>ğŸ“ <strong>Ireland:</strong> 01 2050500<br>ğŸ“ <strong>UK:</strong> 0203 4815711<br><br>Alternatively, share your details here and I'll flag it as <strong>priority</strong> so our team picks it up immediately."
  );
}

function handleFrustrated(text) {
  botSay(
    "I'm sorry you're experiencing issues. Let me make sure we get this sorted for you right away.<br><br>ğŸ“ For immediate help, call us:<br>â€¢ Ireland: 01 2050500<br>â€¢ UK: 0203 4815711<br><br>Or tell me more about the issue and I'll connect you with the right person."
  );
}

function handleBuyingSignal(text) {
  if (CTX.customerStatus === 'existing') {
    botSay("Your account manager can provide detailed information on that. Would you like me to have them reach out, or is there something specific I can answer now?");
  } else {
    botSay("To make sure I point you in the right direction, could you tell me a bit about your business? What type of retail operation are you running?");
    STATE.flow = 'retailer';
    STATE.flowStep = 0;
    STATE.leadData = { inquiry: text };
  }
}

function handleUnknownProductInquiry(rawText) {
  let resp = "While that specific product may not be part of our current brand portfolio, JDM is always exploring new partnerships and expanding our range.";
  resp += "<br><br>Our team can let you know whether we can help, suggest alternatives from our existing brands, or let you know about any upcoming additions to our portfolio.";
  resp += "<br><br>Let me pass your inquiry along â€” could you share your <strong>name</strong> and <strong>business name</strong>?";

  STATE.flow = 'lead';
  STATE.flowStep = 0;
  STATE.leadData = { inquiry: rawText, type: 'unknown_product' };
  botSay(resp);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OBJECTION HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleObjectionExistingDistributor() {
  let resp = "Understood â€” many of our 3,000+ retail partners actually work with multiple distributors â€” each brings different brands and strengths.<br><br>JDM's particular strengths are:<br>â€¢ <strong>30+ brands</strong> including Garmin (official distributor since 2015), Razer, Corsair, Fitbit, and more<br>â€¢ <strong>Local stock</strong> = faster delivery than importing<br>â€¢ <strong>Strong marketing support</strong> including in-store merchandising and training<br>â€¢ <strong>Multi-brand ordering</strong> (one order, multiple brands)";

  if (CTX.mentionedBrands.length) {
    const names = CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ');
    resp += `<br><br>If you're looking specifically for <strong>${names}</strong>, we're one of the leading distributors for those in Ireland/UK.`;
  }

  resp += "<br><br>Even if you're happy with your current setup, it might be worth a conversation about complementing what you already have.";
  botSay(resp);
}

function handleObjectionPrice() {
  let resp = "I appreciate that price is important for your margins. Our pricing varies significantly based on:<br><br>â€¢ Order volume (larger orders = better pricing)<br>â€¢ Payment terms<br>â€¢ Account history and relationship<br>â€¢ Product mix";

  resp += "<br><br>Also consider the total value beyond unit price:<br>â€¢ Local stock = no long lead times or large prepayments<br>â€¢ Marketing support included<br>â€¢ Warranty handling<br>â€¢ 1-3 day delivery<br><br>What volumes are you typically ordering? I can have our team review options that might work for your business.";
  botSay(resp);
}

function handleObjectionDirect() {
  let resp = "That's an option if you're ordering in very large volumes.<br><br>Most retailers find working with a distributor like JDM more efficient because:<br><br>ğŸ’° <strong>Lower Minimums:</strong> Manufacturers often require container-loads; we break bulk<br>ğŸ“¦ <strong>Local Stock:</strong> Next-day delivery vs weeks from overseas<br>ğŸ¯ <strong>Multi-Brand:</strong> Order from 30+ brands in one transaction<br>ğŸ’³ <strong>Better Terms:</strong> Net 30/60 vs prepayment for imports<br>ğŸ“ <strong>Local Support:</strong> We handle warranty, returns, technical queries<br>ğŸ“Š <strong>Marketing:</strong> We provide POS materials and marketing support";

  if (CTX.businessType) {
    resp += `<br><br>For ${CTX.businessType} businesses, the flexibility usually outweighs any small price difference.`;
  }

  resp += "<br><br>Many of our retail partners tried direct importing but came back to us for the convenience. Want to discuss what works best for your scale?";
  botSay(resp);
}

function handleObjectionPriceMatch() {
  let resp = "I can't speak to specific competitor pricing, but we're very competitive across our brands.<br><br>A few things to consider beyond unit price:<br><br>âœ… <strong>Stock availability</strong> â€” Do they have local stock or long lead times?<br>âœ… <strong>Payment terms</strong> â€” What terms do they offer?<br>âœ… <strong>Support level</strong> â€” Marketing support and training?<br>âœ… <strong>Delivery speed</strong> â€” How quickly can they deliver?<br>âœ… <strong>Warranty handling</strong> â€” Who deals with returns?";

  if (CTX.mentionedBrands.length) {
    const names = CTX.mentionedBrands.map(b => BRAND_DB[b]?.name || b).join(', ');
    resp += `<br><br>For <strong>${names}</strong> specifically, we're one of the official distributors, so our pricing is manufacturer-approved.`;
  }

  resp += "<br><br>Let me connect you with our team who can put together a complete package comparison.";
  botSay(resp);
}

function handleObjectionThinkAboutIt() {
  let resp = "Of course â€” take your time. It's an important decision for your business.";

  if (CTX.topicsDiscussed.length) {
    resp += `<br><br>We've covered ${CTX.topicsDiscussed.join(', ')} â€” if any of those raise questions later, just come back.`;
  }

  resp += "<br><br>A few things that might help your decision:<br>â€¢ No obligation to talk with our sales team â€” just an exploratory conversation<br>â€¢ We work with retailers of all sizes<br>â€¢ Many partners start small and expand as they see results";

  if (CTX.businessType && CTX.userLocation) {
    resp += `<br><br>We have quite a few ${CTX.businessType} partners in the ${CTX.userLocation.place} area who've been very happy.`;
  }

  resp += "<br><br>Would it help if I sent you some information via email?";
  botSay(resp);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPECIAL HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleAffirmative(text) {
  // Context-dependent "yes" response
  const lastTopic = CTX.topicsDiscussed[CTX.topicsDiscussed.length - 1];

  if (lastTopic === 'pricing' || lastTopic === 'stock') {
    startLeadFlow('Follow-up on ' + lastTopic);
  } else if (CTX.customerStatus === 'prospect' || !CTX.customerStatus) {
    startLeadFlow('General interest');
  } else {
    botSay("What would you like to know more about?");
  }
}

function handleOffTopic() {
  botSay(
    "I'm specifically here to help with JDM Products and our electronics distribution services.<br><br>I can help you with:<br>â€¢ Our 30+ brands (Garmin, Razer, Fitbit, Tonies, and more)<br>â€¢ Becoming a retail partner<br>â€¢ Stock and ordering<br>â€¢ Account support<br><br>What brings you to JDM today?"
  );
}

function handleDemoQuestion() {
  botSay(
    "This is a demonstration interface showing how our chatbot works. The production version connects to our full AI system which:<br><br>â€¢ Maintains complete conversation context<br>â€¢ Accesses real-time stock data<br>â€¢ Handles any question about your specific needs<br>â€¢ Integrates with our CRM and support systems<br>â€¢ Provides personalised responses based on your account history<br><br>Would you like to learn more about the full system?"
  );
}

function handleFallback(text) {
  // Try to be helpful based on what we can detect
  const brand = detectBrand(text);
  if (brand) { handleSpecificBrand(brand); return; }

  // Level 2 - guide them
  botSay(
    "I want to make sure you get accurate information rather than guessing.<br><br>Are you asking about:<br>â€¢ Products and brands we distribute<br>â€¢ Becoming a retail partner<br>â€¢ Orders and delivery (existing customers)<br>â€¢ Technical support<br>â€¢ Something else<br><br>The more I understand, the better I can help."
  );
}

</script>
</body>
</html>
